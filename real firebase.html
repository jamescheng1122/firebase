    <!DOCTYPE html>
    <html lang="en">

    <head>
        <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.x.x/firebase-firestore-compat.js"></script>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>S-Next 請假及賀金系統</title>
        <style>
            /* Responsive styles */
            @media screen and (max-width: 768px) {
                /* Container adjustments */
                .container {
                    margin: 10px;
                    padding: 10px;
                    width: auto;
                }

                /* Form adjustments */
                form {
                    padding: 10px;
                }

                /* Table responsiveness */
                table {
                    display: block;
                    overflow-x: auto;
                    white-space: nowrap;
                }

                /* Input field adjustments */
                input[type="text"],
                input[type="password"],
                input[type="number"],
                input[type="date"],
                select {
                    font-size: 16px; /* Prevents zoom on iOS */
                    padding: 10px;
                }

                /* Button adjustments */
                button {
                    width: 100%;
                    padding: 12px;
                    margin: 5px 0;
                    font-size: 16px;
                }

                /* Header adjustments */
                header h1 {
                    font-size: 1.5rem;
                    padding: 10px;
                }

                /* Employee information adjustments */
                #employee-page p strong {
                    width: 100%;
                    display: block;
                    margin-bottom: 5px;
                }

                /* Modal adjustments */
                .proof-modal-content {
                    width: 90%;
                    margin: 5% auto;
                }

                /* Penalty form adjustments */
                #penalty-form {
                    grid-template-columns: 1fr;
                }

                /* Status table adjustments */
                .application-status table,
                #employee-penalty-table {
                    font-size: 14px;
                }

                /* Make tables scrollable horizontally */
                .application-list {
                    overflow-x: auto;
                }

                /* Adjust cell padding for better touch targets */
                th, td {
                    padding: 8px;
                }

                /* Stack form elements vertically */
                #add-employee-form,
                #apply-leave-form {
                    display: flex;
                    flex-direction: column;
                    gap: 10px;
                }

                /* Improve button touch targets */
                .remove-btn,
                .show-proof-btn,
                .reject-btn,
                .submit-proof-btn,
                .view-proof-btn {
                    padding: 8px 16px;
                    margin: 5px 0;
                    min-height: 44px; /* Minimum touch target size */
                }

                /* Stack label-input pairs */
                form label {
                    display: block;
                    margin-bottom: 5px;
                }

                /* Adjust spacing for stacked elements */
                h2, h3 {
                    margin-top: 20px;
                    margin-bottom: 10px;
                }
            }

            /* Additional adjustments for very small screens */
            @media screen and (max-width: 480px) {
                /* Further reduce font sizes */
                body {
                    font-size: 14px;
                }

                header h1 {
                    font-size: 1.2rem;
                }

                /* Stack table cells for better readability */
                #employee-penalty-table td,
                #application-status-table td {
                    padding: 6px;
                }

                /* Adjust modal for smaller screens */
                .proof-modal-content {
                    width: 95%;
                    margin: 2% auto;
                }

                /* Make sure buttons are easily tappable */
                button {
                    min-height: 44px;
                }
            }

            /* Improve table scrolling on mobile */
            .table-container {
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin-bottom: 15px;
            }

            /* Add visual indication of scrollable tables */
            .table-container::after {
                content: '⟺';
                position: absolute;
                right: 10px;
                color: #666;
                animation: scroll-hint 1s infinite;
                display: none;
            }

            @media screen and (max-width: 768px) {
                .table-container::after {
                    display: block;
                }
            }

            @keyframes scroll-hint {
                0% { opacity: 0; }
                50% { opacity: 1; }
                100% { opacity: 0; }
            }

            /* Color variables */
            :root {
                --primary-color: #2c3e50;
                --secondary-color: #34495e;
                --accent-color: #3498db;
                --light-bg: #f5f6fa;
                --text-color: #2c3e50;
                --border-color: #dcdde1;
            }

            /* Base styles */
            body {
                font-family: 'Segoe UI', Arial, sans-serif;
                margin: 0;
                padding: 0;
                background-color: var(--light-bg);
                color: var(--text-color);
                line-height: 1.6;
            }

            header {
                background-color: var(--primary-color);
                color: white;
                text-align: center;
                padding: 1rem 0;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }

            header h1 {
                margin: 0;
                font-size: 1.8rem;
            }

            .container {
                max-width: 1000px;
                margin: 20px auto;
                padding: 20px;
                background-color: white;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            }

            /* Form styles */
            form {
                margin-top: 20px;
                padding: 20px;
                background-color: #f8f9fa;
                border-radius: 6px;
            }

            input[type="text"],
            input[type="password"],
            input[type="number"],
            input[type="date"],
            select {
                padding: 8px 12px;
                width: 100%;
                margin-bottom: 15px;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                font-size: 14px;
            }

            button {
                padding: 8px 16px;
                background-color: var(--accent-color);
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                transition: background-color 0.3s;
            }

            button:hover {
                background-color: #2980b9;
            }

            button:disabled {
                background-color: #bdc3c7;
                cursor: not-allowed;
            }

            /* Table styles */
            table {
                width: 100%;
                border-collapse: collapse;
                margin: 20px 0;
                background-color: white;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }

            th, td {
                padding: 12px 15px;
                border: 1px solid var(--border-color);
            }

            th {
                background-color: var(--secondary-color);
                color: white;
                font-weight: 500;
            }

            tr:nth-child(even) {
                background-color: #f8f9fa;
            }

            /* Button variations */
            .remove-btn {
                background-color: #e74c3c;
            }

            .remove-btn:hover {
                background-color: #c0392b;
            }

            .show-proof-btn {
                background-color: #27ae60;
            }

            .show-proof-btn:hover {
                background-color: #219a52;
            }

            .reject-btn {
                background-color: #e74c3c;
                padding: 4px 8px;
                font-size: 12px;
                margin-top: 5px;
            }

            /* Section headings */
            h2, h3 {
                color: var(--primary-color);
                margin-top: 30px;
                padding-bottom: 10px;
                border-bottom: 2px solid var(--border-color);
            }

            /* Company rules section */
            #home-page p {
                padding: 10px;
                background-color: #f8f9fa;
                border-left: 4px solid var(--accent-color);
                margin: 10px 0;
            }

            /* Employee information section */
            #employee-page p {
                padding: 8px;
                margin: 5px 0;
                border-bottom: 1px solid var(--border-color);
            }

            #employee-page p strong {
                color: var(--primary-color);
                width: 200px;
                display: inline-block;
            }

            /* Logout button */
            #logout-btn, #logout-btn-employee {
                background-color: #95a5a6;
                margin-top: 30px;
            }

            #logout-btn:hover, #logout-btn-employee:hover {
                background-color: #7f8c8d;
            }

            /* Modal styles update */
            .proof-modal-content {
                background-color: white;
                border-radius: 8px;
            }

            .close-modal {
                color: #7f8c8d;
            }

            .close-modal:hover {
                color: var(--primary-color);
            }

            #penalty-form {
                display: grid;
                gap: 10px;
                margin-bottom: 20px;
            }

            #penalty-form select,
            #penalty-form input {
                padding: 8px;
                border: 1px solid var(--border-color);
                border-radius: 4px;
            }

            #penalty-form button {
                justify-self: start;
            }

            #penalty-table {
                margin-top: 20px;
            }

            #penalty-reason {
                padding: 8px 12px;
                width: 100%;
                margin-bottom: 15px;
                border: 1px solid var(--border-color);
                border-radius: 4px;
                font-size: 14px;
            }

            #penalty-form select,
            #penalty-form input {
                margin-bottom: 10px;
            }

            #employee-penalty-table {
                width: 100%;
                border-collapse: collapse;
                margin: 20px 0;
                background-color: white;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }

            #employee-penalty-table th,
            #employee-penalty-table td {
                padding: 12px 15px;
                border: 1px solid var(--border-color);
            }

            #employee-penalty-table th {
                background-color: var(--secondary-color);
                color: white;
                font-weight: 500;
            }

            #employee-penalty-table tr:nth-child(even) {
                background-color: #f8f9fa;
            }

            .status-submitted {
                color: green;
                font-weight: bold;
            }

            .status-not-submitted {
                color: red;
                font-weight: bold;
            }

            .submit-proof-btn {
                margin-top: 5px;
                padding: 5px 10px;
                background-color: #4CAF50;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
            }

            .submit-proof-btn:hover {
                background-color: #45a049;
            }

            .view-proof-btn {
                margin-left: 10px;
                padding: 3px 8px;
                background-color: #2196F3;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
            }

            .view-proof-btn:hover {
                background-color: #1976D2;
            }

            .status-submitted {
                color: green;
                font-weight: bold;
            }

            .status-not-submitted {
                color: red;
                font-weight: bold;
            }

            .view-proof-btn {
                margin-left: 10px;
                padding: 3px 8px;
                background-color: #2196F3;
                color: white;
                border: none;
                border-radius: 3px;
                cursor: pointer;
            }

            .view-proof-btn:hover {
                background-color: #1976D2;
            }

            .cancel-double-btn {
            margin-left: 5px;
            padding: 3px 8px;
            background-color: #ff9800;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            }

            .cancel-double-btn:hover {
                background-color: #f57c00;
            }

            .export-btn {
                background-color: #28a745;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                margin-right: 10px;
            }

            .export-btn:hover {
                background-color: #218838;
            }

        </style>

        <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

        <script>
            // Initialize Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyD-VpMInHUcC8XyFZYhVP6ya3QdijbeEuo",
                authDomain: "try1-a0f6e.firebaseapp.com",
                databaseURL: "https://try1-a0f6e-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "try1-a0f6e",
                storageBucket: "try1-a0f6e.firebasestorage.app",
                messagingSenderId: "79009361074",
                appId: "1:79009361074:web:ecde01e8292f8e41892dab"
            };
        
            // Initialize Firebase (only once)
            firebase.initializeApp(firebaseConfig);
            
            // Get Firestore instance
            const db = firebase.firestore();
        </script>
    </head>

    <body>
        <header>
            <h1>S-Next 請假及賀金系統</h1>
        </header>
        <div class="container" id="home-page">
                            <h3>Login</h3>
                            <form id="login-form">
                                <input type="text" id="username" placeholder="Username" required>
                                <input type="password" id="password" placeholder="Password/Code" required>
                                <button type="submit">Login</button>
                            </form>
        </div>

        <div class="container" id="admin-page" style="display: none;">
            <h2>Admin Interface</h2>
            <h3>Add Agents</h3>
            <form id="add-employee-form">
                <input type="text" id="emp-name" placeholder="Agent Name" required>
                <input type="text" id="emp-code" placeholder="Agent Code" required>
                <label for="emp-role">Role position:</label>
                <select id="emp-role" required>
                    <option value="Agent">Agent</option>
                    <option value="AUM/UM">AUM/UM</option>
                    <option value="SUM">SUM</option>
                    <option value="BM">BM</option>
                    <option value="DM">DM</option>
                    <option value="DD">DD</option>
                </select>
                <label for="emp-mdrt">Clubs & Awards</label>
                <select id="emp-mdrt" required>
                    <option value="no">NO</option>
                    <option value="mdrt">MDRT</option>
                    <option value="cot or above">COT or above</option>
                </select>
                <button type="button" id="add-employee-btn" disabled>Add Agent</button>
            </form>

            <h3>賀金</h3>
            <form id="penalty-form">
                <select id="penalty-employee" required>
                    <option value="">Select Employee</option>
                </select>
                <input type="date" id="penalty-date" required>
                <select id="penalty-reason" required>
                    <option value="Meeting">Meeting</option>
                </select>
                <input type="number" id="penalty-minutes" placeholder="Late Minutes" min="0" required>
                <p><strong>備註：No Show請輸入500</span></p>
                <button type="submit">Add 賀金</button>
            </form>

            <h3>Agent List</h3>
            <div class="table-container">
                <table id="employee-table">
                <thead>
                    <tr>
                        <th style="padding: 10px;">Name</th>
                        <th style="padding: 10px;">Code</th>
                        <th style="padding: 10px;">Role</th>
                        <th style="padding: 10px;">Clubs & Awards</th>
                        <th style="padding: 10px;">Remaining Annual Leaves (Normal)</th>
                        <th style="padding: 10px;">Remaining Annual Leaves (黃金事假)</th>
                        <th style="padding: 10px;">Action</th>
                    </tr>
                </thead>
                <tbody id="employee-list">
                </tbody>
            </table>
            </div>

            <!-- Update the employee application table -->
            <h3>Agent Leave Application Record</h3>
            <div class="export-buttons" style="margin-top: 20px;">
                <button id="export-applications-btn" class="export-btn">Export Applications to Excel</button>
            </div>
            <div class="table-container">
                <table id="application-list-table">
                    <thead>
                        <tr>
                            <th>Agent Name</th>
                            <th>Apply Date</th>
                            <th>Leave Start Date</th>
                            <th>Leave End Date</th>
                            <th>Leave Type</th>
                            <th>Status</th>
                            <th>Proof</th>
                        </tr>
                    </thead>
                    <tbody id="application-list-body"></tbody>
                </table>
            </div>

            <h3>賀金 Info</h3>
            <div class="export-buttons" style="margin-top: 20px;">
                <button id="export-penalties-btn" class="export-btn">Export Penalties to Excel</button>
            </div>
            <div class="table-container">
                <table id="penalty-table">
                    <thead>
                        <tr>
                            <th>Agent Name</th>
                            <th>Date</th>
                            <th>Reason</th>
                            <th>Late Minutes</th>
                            <th>Amount</th>
                            <th>Deadline</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="penalty-list"></tbody>
                </table>
            </div>

            <!-- Add the logout button here -->
            <button id="logout-btn">Logout</button>
        </div>

        <div class="container" id="employee-page" style="display: none;">
            <h2>Agent Information</h2>
            <p><strong>Name:</strong> <span id="employee-name"></span></p>
            <p><strong>Code:</strong> <span id="employee-code"></span></p>
            <p><strong>Role:</strong> <span id="employee-role"></span></p>
            <p><strong>Clubs & Awards:</strong> <span id="employee-mdrt"></span></p>
            <p><strong>Annual Leaves (Normal):</strong> <span id="employee-leave-normal"></span></p>
            <p><strong>Annual Leaves (黃金事假):</strong> <span id="employee-leave-golden"></span></p>
            <p><strong>Remaining Annual Leaves (Normal):</strong> <span id="remaining-leave-normal"></span></p>
            <p><strong>Remaining Annual Leaves (黃金事假):</strong> <span id="remaining-leave-golden"></span></p>
            <p><strong>Used Sick Leave Days:</strong> <span id="used-sick-leave">0</span></p>
            <p><strong>Used 不可抗力因素 Days:</strong> <span id="used-force-majeure">0</span></p>
            <p><strong>Used 離港 Days:</strong> <span id="used-overseas">0</span></p>
            <p><strong>備註：Annual Leaves (黃金事假)包含於Annual Leaves (Normal)之內</span></p>

            <!-- Update the leave application form -->
            <h3>Apply for Leave</h3>
            <form id="apply-leave-form">
                <label for="apply-date">Apply Date:</label>
                <input type="date" id="apply-date" required>
                <label for="leave-start-date">Leave Start Date:</label>
                <input type="date" id="leave-start-date" required>
                <label for="leave-end-date">Leave End Date:</label>
                <input type="date" id="leave-end-date" required>
                <p>
                <label for="leave-type">Leave Type:</label>
                <select id="leave-type" required>
                    <option value="Annual Leave (Normal)">Annual Leave (Normal)</option>
                    <option value="Annual Leave (黃金事假)">Annual Leave (黃金事假)</option>
                    <option value="Sick Leave">Sick Leave</option>
                    <option value="不可抗力因素">不可抗力因素</option>
                    <option value="離港">離港</option>
                </select>
                <div id="force-majeure-options" style="display: none;">
                    <label for="force-majeure-reason">Reason:</label>
                    <select id="force-majeure-reason">
                        <option value="">Select a reason</option>
                        <option value="大學生考試">大學生考試</option>
                        <option value="IIQE PAPER 1 & 3 考試">IIQE PAPER 1 & 3 考試</option>
                        <option value="擔任公司/其他區域的分享嘉賓及伴同出席分享的同事">擔任公司/其他區域的分享嘉賓及伴同出席分享的同事</option>
                        <option value="參加公司活動(只有一個時間)">參加公司活動(只有一個時間)</option>
                        <option value="參加頒獎典禮及領獎">參加頒獎典禮及領獎</option>
                        <option value="CIAM課程">CIAM課程</option>
                        <option value="PA/EDP/PA & EDP Elite/FP/新UM課程">PA/EDP/PA & EDP Elite/FP/新UM課程</option>
                        <option value="正日莊務">正日莊務</option>
                        <option value="考車正日">考車正日</option>
                        <option value="直系親屬紅白二事(包括自己結婚)">直系親屬紅白二事(包括自己結婚)</option>
                        <option value="陪同行動不便的父母、子女、配偶見醫生(需當日提供合理證明)">陪同行動不便的父母、子女、配偶見醫生(需當日提供合理證明)</option>
                        <option value="陪同寵物見醫生(同事是唯一照顧者&需當日提供合理證明)">陪同寵物見醫生(同事是唯一照顧者&需當日提供合理證明)</option>
                    </select>
                </div>
                <div id="proof-container" style="display: none;">
                    <label for="proof-file">Proof:</label>
                    <input type="file" id="proof-file" accept="image/*">
                </div>
                <button type="submit">Apply</button>
            </form>

            <div class="application-status">
                <h3>Application Status</h3>
                <div class="table-container">
                    <table id="application-status-table">
                    <tr>
                        <th>Apply Date</th>
                        <th>Leave Start Date</th>
                        <th>Leave End Date</th>
                        <th>Leave Type</th>
                        <th>Status</th>
                    </tr>
                    </table>
                </div>
            </div>

            <h3>賀金 Info</h3>
            <div class="table-container">
                <table id="employee-penalty-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Reason</th>
                            <th>Late Minutes</th>
                            <th>Amount</th>
                            <th>Deadline</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="employee-penalty-list"></tbody>
                </table>
            </div>

            <div id="penalty-total" style="text-align: right; margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                <strong>Total (Not Submitted): $<span id="penalty-sum">0</span></strong>
            </div>
                
                <input type="file" id="proof-upload" accept="image/*" style="display: none;">

            <!-- Move the logout button downwards -->
            <div style="margin-top: 20px;">
                <button id="logout-btn-employee">Logout</button>
            </div>

            <div id="sync-status" style="position: fixed; bottom: 10px; right: 10px; padding: 8px; border-radius: 4px; background: #2ecc71; color: white; display: none;">
                Changes synced ✓
            </div>
        </div>

        <script>

            // Add these utility functions at the beginning of your JavaScript code
            const ROWS_PER_PAGE = 10;

            function createPagination(tableId) {
                const table = document.getElementById(tableId);
                if (!table) return;

                let tbody = table.querySelector('tbody');
                if (!tbody) {
                    tbody = table; // For tables without tbody
                }

                // Store current page in table's dataset to persist across updates
                if (!table.dataset.currentPage) {
                    table.dataset.currentPage = '1';
                }

                function updateTableWithPagination(preservePage = true) {
                    // Store all rows in an array, excluding the header row
                    let rows = Array.from(tbody.getElementsByTagName('tr'));
                    if (rows.length <= 1) return; // Return if only header row or empty

                    // Store the header row
                    const headerRow = rows[0];
                    // Remove header row from the rows array
                    rows = rows.slice(1);

                    // Sort rows by date (newest first)
                    rows.sort((a, b) => {
                        const dateA = new Date(getDateFromRow(a));
                        const dateB = new Date(getDateFromRow(b));
                        return dateB - dateA;
                    });

                    const pageCount = Math.ceil(rows.length / ROWS_PER_PAGE);
                    let currentPage = preservePage ? parseInt(table.dataset.currentPage) : 1;
                    
                    // Ensure currentPage is valid
                    if (currentPage > pageCount) {
                        currentPage = pageCount;
                    }
                    table.dataset.currentPage = currentPage.toString();

                    function getDateFromRow(row) {
                        // Get date from the appropriate column based on table
                        if (tableId === 'application-status-table' || tableId === 'application-list-table') {
                            return row.cells[0].textContent; // Apply Date column
                        } else if (tableId === 'penalty-table' || tableId === 'employee-penalty-table') {
                            return row.cells[0].textContent; // Date column
                        }
                        return row.cells[0].textContent; // Default to first column
                    }

                    function showPage(page) {
                        // Clear tbody
                        tbody.innerHTML = '';
                        
                        // Add header row back
                        tbody.appendChild(headerRow.cloneNode(true));
                        
                        // Calculate start and end indices
                        const start = (page - 1) * ROWS_PER_PAGE;
                        const end = Math.min(start + ROWS_PER_PAGE, rows.length);
                        
                        // Add rows for current page
                        for (let i = start; i < end; i++) {
                            tbody.appendChild(rows[i].cloneNode(true));
                        }
                        
                        table.dataset.currentPage = page.toString();
                        updatePaginationButtons();
                    }

                    function updatePaginationButtons() {
                        // Remove existing pagination controls if any
                        const existingPagination = table.nextElementSibling;
                        if (existingPagination && existingPagination.classList.contains('pagination-controls')) {
                            existingPagination.remove();
                        }

                        // Only show pagination if there are multiple pages
                        if (pageCount <= 1) return;

                        const paginationDiv = document.createElement('div');
                        paginationDiv.className = 'pagination-controls';
                        paginationDiv.style.cssText = `
                            margin-top: 10px;
                            margin-bottom: 20px;
                            text-align: center;
                        `;

                        // Previous button
                        const prevButton = document.createElement('button');
                        prevButton.textContent = '← Previous';
                        prevButton.className = 'pagination-btn';
                        prevButton.disabled = currentPage === 1;
                        prevButton.onclick = () => {
                            if (currentPage > 1) {
                                currentPage--;
                                showPage(currentPage);
                            }
                        };

                        // Next button
                        const nextButton = document.createElement('button');
                        nextButton.textContent = 'Next →';
                        nextButton.className = 'pagination-btn';
                        nextButton.disabled = currentPage === pageCount;
                        nextButton.onclick = () => {
                            if (currentPage < pageCount) {
                                currentPage++;
                                showPage(currentPage);
                            }
                        };

                        // Page indicator
                        const pageIndicator = document.createElement('span');
                        pageIndicator.textContent = ` Page ${currentPage} of ${pageCount} `;
                        pageIndicator.style.margin = '0 10px';

                        paginationDiv.appendChild(prevButton);
                        paginationDiv.appendChild(pageIndicator);
                        paginationDiv.appendChild(nextButton);

                        // Insert pagination controls after the table
                        table.parentNode.insertBefore(paginationDiv, table.nextSibling);
                    }

                    // Initial display
                    showPage(currentPage);
                }

                // Initial update
                updateTableWithPagination(false);

                // Add real-time update listener
                if (firebase && firebase.firestore) {
                    const db = firebase.firestore();
                    const dataTypes = {
                        'application-status-table': 'applications',
                        'application-list-table': 'applications',
                        'penalty-table': 'penaltyData',
                        'employee-penalty-table': 'penaltyData'
                    };

                    const dataType = dataTypes[tableId];
                    if (dataType) {
                        db.collection('systemData').doc(dataType)
                            .onSnapshot((doc) => {
                                if (doc.exists && doc.data()) {
                                    // Update table while maintaining current page
                                    updateTableWithPagination(true);
                                }
                            });
                    }
                }

                // Return the update function for external use
                return () => updateTableWithPagination(true);
            }
            
            // Add this code block right at the start of your script section
            const styleSheet = document.createElement('style');
            styleSheet.textContent = `
                .proof-modal {
                    display: none;
                    position: fixed;
                    z-index: 1000;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.7);
                    opacity: 0;
                    transition: opacity 0.3s ease;
                }

                .proof-modal.show {
                    opacity: 1;
                }

                .proof-modal-content {
                    position: relative;
                    background-color: #fefefe;
                    margin: 10% auto;
                    padding: 20px;
                    border: 1px solid #888;
                    width: 60%;
                    max-width: 700px;
                    border-radius: 5px;
                    transform: translateY(-20px);
                    transition: transform 0.3s ease;
                }

                .proof-modal.show .proof-modal-content {
                    transform: translateY(0);
                }

                .proof-modal img {
                    width: 100%;
                    max-height: 70vh;
                    object-fit: contain;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                }

                .proof-modal.show img {
                    opacity: 1;
                }

                .close-modal {
                    position: absolute;
                    right: 10px;
                    top: 5px;
                    color: #aaa;
                    font-size: 28px;
                    font-weight: bold;
                    cursor: pointer;
                    transition: color 0.2s ease;
                }

                .close-modal:hover {
                    color: #000;
                }

                .remove-penalty-btn {
                    margin-left: 10px;
                    padding: 3px 8px;
                    background-color: #dc3545;
                    color: white;
                    border: none;
                    border-radius: 3px;
                    cursor: pointer;
                    transition: background-color 0.2s ease;
                }

                .remove-penalty-btn:hover {
                    background-color: #c82333;
                }
                
                .role-select,
                .mdrt-select {
                    padding: 5px;
                    border: 1px solid var(--border-color);
                    border-radius: 4px;
                    background-color: white;
                    width: 100%;
                    transition: border-color 0.2s ease;
                }

                .role-select:focus,
                .mdrt-select:focus {
                    outline: none;
                    border-color: var(--accent-color);
                }

                /* Add styles for real-time update indicators */
                .update-indicator {
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background-color: #2ecc71;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 4px;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                    opacity: 0;
                    transform: translateY(20px);
                    transition: all 0.3s ease;
                    z-index: 1001;
                }

                .update-indicator.show {
                    opacity: 1;
                    transform: translateY(0);
                }

                /* Add loading indicator styles */
                .loading-overlay {
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(255,255,255,0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    opacity: 0;
                    visibility: hidden;
                    transition: opacity 0.2s ease;
                }

                .loading-overlay.show {
                    opacity: 1;
                    visibility: visible;
                }

                .loading-spinner {
                    width: 40px;
                    height: 40px;
                    border: 3px solid #f3f3f3;
                    border-top: 3px solid var(--accent-color);
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                }

                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(styleSheet);

            // Enhanced calculateDaysBetween function with validation and caching
            const calculateDaysBetween = (() => {
                const cache = new Map();

                return function(startDate, endDate) {
                    // Create cache key
                    const cacheKey = `${startDate}-${endDate}`;
                    
                    // Check cache first
                    if (cache.has(cacheKey)) {
                        return cache.get(cacheKey);
                    }

                    // Input validation
                    if (!startDate || !endDate) {
                        console.warn('Invalid date input in calculateDaysBetween');
                        return 0;
                    }

                    try {
                        const start = new Date(startDate);
                        const end = new Date(endDate);

                        // Validate dates
                        if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                            console.warn('Invalid date format in calculateDaysBetween');
                            return 0;
                        }

                        // Calculate days
                        const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                        
                        // Cache the result
                        cache.set(cacheKey, days);

                        return days;
                    } catch (error) {
                        console.error('Error in calculateDaysBetween:', error);
                        return 0;
                    }
                };
            })();

            // Add update indicator element
            const updateIndicator = document.createElement('div');
            updateIndicator.className = 'update-indicator';
            updateIndicator.textContent = '✓ Updated';
            document.body.appendChild(updateIndicator);

            // Function to show update indicator
            function showUpdateIndicator() {
                updateIndicator.classList.add('show');
                setTimeout(() => {
                    updateIndicator.classList.remove('show');
                }, 2000);
            }

            // Function to create loading overlay
            function createLoadingOverlay(parentElement) {
                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.innerHTML = '<div class="loading-spinner"></div>';
                parentElement.appendChild(overlay);
                return overlay;
            }

            function updateLeaveUsageCounts(employeeName) {
                const db = firebase.firestore();
                const savedEmployeeData = localStorage.getItem('employeeData');
                
                if (savedEmployeeData) {
                    const employeeData = JSON.parse(savedEmployeeData);
                    const employee = employeeData.find(emp => emp.name === employeeName);
                    
                    if (employee && employee.applications) {
                        let sickLeaveDays = 0;
                        let forceMajeureDays = 0;
                        let overseasDays = 0;

                        employee.applications.forEach(application => {
                            if (application.status === 'Approved') {
                                const startDate = new Date(application.leaveStartDate);
                                const endDate = new Date(application.leaveEndDate);
                                const days = calculateDaysBetween(startDate, endDate);
                                
                                switch (application.leaveType) {
                                    case 'Sick Leave':
                                        sickLeaveDays += days;
                                        break;
                                    case '不可抗力因素':
                                        forceMajeureDays += days;
                                        break;
                                    case '離港':
                                        overseasDays += days;
                                        break;
                                }
                            }
                        });

                        // Save the counts to the employee data
                        employee.leaveUsage = {
                            sickLeaveDays,
                            forceMajeureDays,
                            overseasDays
                        };

                        // Update both localStorage and Firebase
                        localStorage.setItem('employeeData', JSON.stringify(employeeData));
                        db.collection('systemData').doc('employeeData').set({
                            value: JSON.stringify(employeeData),
                            timestamp: new Date()
                        }).catch(error => console.error('Firebase update error:', error));

                        // Update the display
                        const usedSickLeaveElement = document.getElementById('used-sick-leave');
                        const usedForceMajeureElement = document.getElementById('used-force-majeure');
                        const usedOverseasElement = document.getElementById('used-overseas');

                        if (usedSickLeaveElement) usedSickLeaveElement.textContent = sickLeaveDays;
                        if (usedForceMajeureElement) usedForceMajeureElement.textContent = forceMajeureDays;
                        if (usedOverseasElement) usedOverseasElement.textContent = overseasDays;
                    }
                }
            }

            async function updateEmployeeRole(selectElement) {
                const db = firebase.firestore();
                const row = selectElement.closest('tr');
                const employeeName = row.cells[0].textContent;
                const newRole = selectElement.value;
                
                try {
                    // Show loading indicator
                    const loadingOverlay = createLoadingOverlay(row);
                    loadingOverlay.classList.add('show');
                    
                    // Update in both localStorage and Firebase
                    const savedEmployeeData = localStorage.getItem('employeeData');
                    if (savedEmployeeData) {
                        const employeeData = JSON.parse(savedEmployeeData);
                        const employee = employeeData.find(emp => emp.name === employeeName);
                        if (employee) {
                            employee.role = newRole;
                            
                            // Update localStorage
                            localStorage.setItem('employeeData', JSON.stringify(employeeData));
                            
                            // Update Firebase
                            await db.collection('systemData').doc('employeeData').set({
                                value: JSON.stringify(employeeData),
                                timestamp: new Date()
                            });
                            
                            // Show success indicator
                            showUpdateIndicator();
                        }
                    }
                } catch (error) {
                    console.error('Error updating employee role:', error);
                    // Revert the select value if there's an error
                    selectElement.value = employee.role;
                    alert('Failed to update role. Please try again.');
                } finally {
                    // Remove loading overlay
                    const loadingOverlay = row.querySelector('.loading-overlay');
                    if (loadingOverlay) {
                        loadingOverlay.classList.remove('show');
                        setTimeout(() => loadingOverlay.remove(), 300);
                    }
                }
            }

            async function updateEmployeeMDRT(selectElement) {
                const db = firebase.firestore();
                const row = selectElement.closest('tr');
                const employeeName = row.cells[0].textContent;
                const newMDRT = selectElement.value;
                
                try {
                    // Show loading indicator
                    const loadingOverlay = createLoadingOverlay(row);
                    loadingOverlay.classList.add('show');
                    
                    // Update in both localStorage and Firebase
                    const savedEmployeeData = localStorage.getItem('employeeData');
                    if (savedEmployeeData) {
                        const employeeData = JSON.parse(savedEmployeeData);
                        const employee = employeeData.find(emp => emp.name === employeeName);
                        if (employee) {
                            employee.empMDRT = newMDRT;
                            
                            // Calculate new leave amounts based on MDRT status
                            let newLeaveNormal, newLeaveGolden;
                            if (newMDRT === 'cot or above') {
                                newLeaveNormal = '∞';
                                newLeaveGolden = '∞';
                            } else {
                                newLeaveNormal = newMDRT === 'mdrt' ? 13 : 10;
                                newLeaveGolden = 3;
                            }
                            
                            // Update leave amounts
                            employee.leaveNormal = newLeaveNormal;
                            employee.leaveGolden = newLeaveGolden;
                            employee.remainingLeaveNormal = newLeaveNormal;
                            employee.remainingLeaveGolden = newLeaveGolden;
                            
                            // Update the row display
                            row.cells[4].textContent = newLeaveNormal;
                            row.cells[5].textContent = newLeaveGolden;
                            
                            // Update localStorage
                            localStorage.setItem('employeeData', JSON.stringify(employeeData));
                            
                            // Update Firebase
                            await db.collection('systemData').doc('employeeData').set({
                                value: JSON.stringify(employeeData),
                                timestamp: new Date()
                            });
                            
                            // Show success indicator
                            showUpdateIndicator();
                        }
                    }
                } catch (error) {
                    console.error('Error updating employee MDRT:', error);
                    // Revert the select value if there's an error
                    selectElement.value = employee.empMDRT;
                    alert('Failed to update MDRT status. Please try again.');
                } finally {
                    // Remove loading overlay
                    const loadingOverlay = row.querySelector('.loading-overlay');
                    if (loadingOverlay) {
                        loadingOverlay.classList.remove('show');
                        setTimeout(() => loadingOverlay.remove(), 300);
                    }
                }
            }

            // Element references
            const loginForm = document.getElementById('login-form');
            const adminPage = document.getElementById('admin-page');
            const addEmployeeForm = document.getElementById('add-employee-form');
            const removeEmployeeForm = document.getElementById('remove-employee-form');
            const addEmployeeBtn = document.getElementById('add-employee-btn');
            const removeEmployeeBtn = document.getElementById('remove-employee-btn');
            const employeePage = document.getElementById('employee-page');
            const employeeName = document.getElementById('employee-name');
            const employeeCode = document.getElementById('employee-code');
            const employeeLeave = document.getElementById('employee-leave');
            const remainingLeave = document.getElementById('remaining-leave');

            // Enhanced save function with Firebase support
            async function saveEmployeeData() {
                try {
                    const employeeData = Array.from(employeeList.getElementsByTagName('tr')).map(row => {
                        const cells = row.getElementsByTagName('td');
                        return {
                            name: cells[0].textContent,
                            code: cells[1].textContent,
                            leave: cells[2].querySelector('.leave-days').textContent,
                            applications: []
                        };
                    });

                    employeeData.forEach(employee => {
                        const applicationRows = Array.from(document.querySelectorAll(`#application-status-table tr[data-employee="${employee.name}"]`));
                        applicationRows.forEach(row => {
                            const cells = row.getElementsByTagName('td');
                            employee.applications.push({
                                applyDate: cells[0].textContent,
                                leaveStartDate: cells[1].textContent,
                                leaveEndDate: cells[2].textContent,
                                leaveType: cells[3].textContent,
                                status: cells[4].textContent
                            });
                        });
                    });

                    // Save to localStorage
                    localStorage.setItem('employeeData', JSON.stringify(employeeData));

                    // Save to Firebase
                    await db.collection('systemData').doc('employeeData').set({
                        value: JSON.stringify(employeeData),
                        timestamp: new Date()
                    });

                    showUpdateIndicator();
                } catch (error) {
                    console.error('Error saving employee data:', error);
                    alert('Failed to save changes. Please try again.');
                }
            }

            // Utility functions
            function isToday(date) {
                const today = new Date();
                return date.getDate() === today.getDate() &&
                    date.getMonth() === today.getMonth() &&
                    date.getFullYear() === today.getFullYear();
            }

            function isTomorrowOrLater(date) {
                const today = new Date();
                today.setDate(today.getDate() + 1);
                return date >= today;
            }

            // Enhanced load function with Firebase real-time updates
            function initializeDataListeners() {
                // Set up real-time listener for employee data
                db.collection('systemData').doc('employeeData')
                    .onSnapshot((doc) => {
                        if (doc.exists && doc.data()) {
                            const employeeData = JSON.parse(doc.data().value);
                            
                            // Update localStorage
                            localStorage.setItem('employeeData', JSON.stringify(employeeData));
                            
                            // Update UI if employee page is active
                            const loggedInEmployee = employeeData.find(employee => 
                                employee.name === employeeName?.textContent
                            );

                            if (loggedInEmployee && employeePage.style.display !== 'none') {
                                updateApplicationTable(loggedInEmployee);
                            }
                        }
                    }, (error) => {
                        console.error("Error listening to employee data:", error);
                    });
            }

            // Function to update application table
            function updateApplicationTable(loggedInEmployee) {
                const applicationStatusTable = document.getElementById('application-status-table');
                if (!applicationStatusTable) return;

                const uniqueApplications = [];
                
                loggedInEmployee.applications.forEach(application => {
                    const isDuplicate = uniqueApplications.some(uniqueApp =>
                        uniqueApp.applyDate === application.applyDate &&
                        uniqueApp.leaveStartDate === application.leaveStartDate &&
                        uniqueApp.leaveEndDate === application.leaveEndDate &&
                        uniqueApp.leaveType === application.leaveType &&
                        uniqueApp.status === application.status
                    );

                    if (!isDuplicate) {
                        uniqueApplications.push(application);
                    }
                });

                // Clear existing rows
                while (applicationStatusTable.rows.length > 1) {
                    applicationStatusTable.deleteRow(1);
                }

                // Add new rows
                uniqueApplications.forEach(application => {
                    const applyDateTime = new Date(application.applyDate);
                    const newRow = document.createElement('tr');
                    newRow.setAttribute('data-employee', loggedInEmployee.name);
                    newRow.innerHTML = `
                        <td>${applyDateTime.toLocaleString()}</td>
                        <td>${application.leaveStartDate}</td>
                        <td>${application.leaveEndDate}</td>
                        <td>${application.leaveType}</td>
                        <td>${application.status}</td>
                    `;
                    applicationStatusTable.appendChild(newRow);
                });
            }

            // Initialize event listeners
            window.addEventListener('load', function() {
                // Initialize Firebase listeners
                initializeDataListeners();

                // Load initial data
                const savedEmployeeData = localStorage.getItem('employeeData');
                if (savedEmployeeData) {
                    const employeeData = JSON.parse(savedEmployeeData);
                    const loggedInEmployee = employeeData.find(employee => 
                        employee.name === employeeName?.textContent
                    );
                    
                    if (loggedInEmployee) {
                        updateApplicationTable(loggedInEmployee);
                    }
                }
            });

            // Add error boundary
            window.addEventListener('unhandledrejection', function(event) {
                console.error('Unhandled promise rejection:', event.reason);
                alert('An error occurred. Please refresh the page and try again.');
            });

            // Update the logout button code
            const logoutBtn = document.getElementById('logout-btn');
            const logoutBtnEmployee = document.getElementById('logout-btn-employee');

            logoutBtn.addEventListener('click', async function() {
                try {
                    adminPage.style.display = 'none';
                    document.getElementById('home-page').style.display = 'block';
                    
                    // Remove the proof popup element from the DOM
                    const proofPopup = document.querySelector('.proof-popup');
                    if (proofPopup) {
                        proofPopup.remove();
                    }
                    
                    await saveEmployeeData();
                    await firebase.auth().signOut();
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Error during logout. Please try again.');
                }
            });

            // Update the logout button event listener in the employee page
            logoutBtnEmployee.addEventListener('click', async function() {
                try {
                    employeePage.style.display = 'none';
                    document.getElementById('home-page').style.display = 'block';
                    document.getElementById('employee-penalty-list').innerHTML = ''; // Clear penalty list
                    await saveEmployeeData();
                    await firebase.auth().signOut();
                } catch (error) {
                    console.error('Employee logout error:', error);
                    alert('Error during logout. Please try again.');
                }
            });

            loginForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                try {
                    if (username === '1' && password === '1') {
                        // Admin login
                        document.getElementById('home-page').style.display = 'none';
                        adminPage.style.display = 'block';
                    } else {
                        // Set up real-time listener for employee data
                        const unsubscribe = db.collection('systemData').doc('employeeData')
                            .onSnapshot(async (doc) => {
                                if (doc.exists) {
                                    const employeeData = JSON.parse(doc.data().value);
                                    const employeeRow = employeeData.find(employee => 
                                        employee.name === username && employee.code === password
                                    );

                                    if (employeeRow) {
                                        // Update UI elements
                                        employeeName.textContent = employeeRow.name;
                                        employeeCode.textContent = employeeRow.code;
                                        document.getElementById('employee-role').textContent = employeeRow.role;
                                        document.getElementById('employee-mdrt').textContent = employeeRow.empMDRT.toUpperCase();
                                        
                                        document.getElementById('employee-leave-normal').textContent = employeeRow.leaveNormal;
                                        document.getElementById('employee-leave-golden').textContent = employeeRow.leaveGolden;
                                        
                                        document.getElementById('remaining-leave-normal').textContent = 
                                            employeeRow.remainingLeaveNormal !== undefined ? employeeRow.remainingLeaveNormal : employeeRow.leaveNormal;
                                        document.getElementById('remaining-leave-golden').textContent = 
                                            employeeRow.remainingLeaveGolden !== undefined ? employeeRow.remainingLeaveGolden : employeeRow.leaveGolden;

                                        // Initialize or update leave usage
                                        if (!employeeRow.leaveUsage) {
                                            employeeRow.leaveUsage = {
                                                sickLeaveDays: 0,
                                                forceMajeureDays: 0,
                                                overseasDays: 0
                                            };
                                        }

                                        // Update leave usage display
                                        document.getElementById('used-sick-leave').textContent = employeeRow.leaveUsage.sickLeaveDays || 0;
                                        document.getElementById('used-force-majeure').textContent = employeeRow.leaveUsage.forceMajeureDays || 0;
                                        document.getElementById('used-overseas').textContent = employeeRow.leaveUsage.overseasDays || 0;

                                        // Update real-time counts
                                        updateLeaveUsageCounts(employeeRow.name);

                                        // Load penalties
                                        loadEmployeePenalties(employeeRow.name);

                                        // Clear and update application status table
                                        updateApplicationTable(employeeRow);

                                        // Switch to employee page
                                        document.getElementById('home-page').style.display = 'none';
                                        employeePage.style.display = 'block';

                                        // Store current user data in localStorage for offline access
                                        localStorage.setItem('currentEmployee', JSON.stringify(employeeRow));
                                    } else {
                                        alert('Invalid username or password. Please try again.');
                                    }
                                }
                            }, (error) => {
                                console.error("Error getting employee data:", error);
                                alert('Error accessing employee data. Please try again.');
                            });

                        // Store unsubscribe function for cleanup
                        window.addEventListener('beforeunload', () => {
                            unsubscribe();
                        });
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    alert('Error during login. Please try again.');
                }

                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            });

            // Helper function to update application table
            function updateApplicationTable(employeeRow) {
                const applicationStatusTable = document.getElementById('application-status-table');
                applicationStatusTable.innerHTML = `
                    <tr>
                        <th>Apply Date</th>
                        <th>Leave Start Date</th>
                        <th>Leave End Date</th>
                        <th>Leave Type</th>
                        <th>Status</th>
                    </tr>
                `;

                if (employeeRow.applications && employeeRow.applications.length > 0) {
                    employeeRow.applications.forEach(application => {
                        const newRow = document.createElement('tr');
                        newRow.setAttribute('data-employee', employeeRow.name);
                        newRow.innerHTML = `
                            <td>${application.applyDate}</td>
                            <td>${application.leaveStartDate}</td>
                            <td>${application.leaveEndDate}</td>
                            <td>${application.leaveType}</td>
                            <td>${application.status}</td>
                        `;
                        applicationStatusTable.appendChild(newRow);
                    });
                    // Update pagination
                    createPagination('application-status-table');
                }
            }

            // Add connection status monitoring
            firebase.firestore().enablePersistence()
                .catch((err) => {
                    if (err.code === 'failed-precondition') {
                        console.warn('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                    } else if (err.code === 'unimplemented') {
                        console.warn('The current browser does not support persistence.');
                    }
                });

            // Monitor online status
            firebase.firestore().enableNetwork().then(() => {
                console.log('Network connectivity restored');
            }).catch((err) => {
                console.error('Error enabling network:', err);
            });

            const empNameInput = document.getElementById('emp-name');
            const empCodeInput = document.getElementById('emp-code');

            function validateAddEmployeeForm() {
                const isNameFilled = empNameInput.value.trim() !== '';
                const isCodeFilled = empCodeInput.value.trim() !== '';
                addEmployeeBtn.disabled = !(isNameFilled && isCodeFilled);
            }

            empNameInput.addEventListener('input', validateAddEmployeeForm);
            empCodeInput.addEventListener('input', validateAddEmployeeForm);

            // Add event listener for adding an employee
            addEmployeeBtn.addEventListener('click', async function() {
                const empName = empNameInput.value.trim();
                const empCode = empCodeInput.value.trim();
                const empMDRT = document.getElementById('emp-mdrt').value;
                const empRole = document.getElementById('emp-role').value;

                if (empName === '' || empCode === '' || empRole === '') {
                    alert('Please fill in all fields');
                    return;
                }

                let totalLeaveNormal, totalLeaveGolden;
                if (empMDRT === 'cot or above') {
                    totalLeaveNormal = '∞';
                    totalLeaveGolden = '∞';
                } else {
                    totalLeaveNormal = empMDRT === 'mdrt' ? 13 : 10;
                    totalLeaveGolden = 3;
                }

                // Create a new table row for the employee with MDRT status (UI remains the same)
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${empName}</td>
                    <td>${empCode}</td>
                    <td>
                        <select class="role-select" onchange="updateEmployeeRole(this)">
                            <option value="Agent" ${empRole === 'Agent' ? 'selected' : ''}>Agent</option>
                            <option value="AUM/UM" ${empRole === 'AUM/UM' ? 'selected' : ''}>AUM/UM</option>
                            <option value="SUM" ${empRole === 'SUM' ? 'selected' : ''}>SUM</option>
                            <option value="BM" ${empRole === 'BM' ? 'selected' : ''}>BM</option>
                            <option value="DM" ${empRole === 'DM' ? 'selected' : ''}>DM</option>
                            <option value="DD" ${empRole === 'DD' ? 'selected' : ''}>DD</option>
                        </select>
                    </td>
                    <td>
                        <select class="mdrt-select" onchange="updateEmployeeMDRT(this)">
                            <option value="no" ${empMDRT === 'no' ? 'selected' : ''}>NO</option>
                            <option value="mdrt" ${empMDRT === 'mdrt' ? 'selected' : ''}>MDRT</option>
                            <option value="cot or above" ${empMDRT === 'cot or above' ? 'selected' : ''}>COT or above</option>
                        </select>
                    </td>
                    <td>${totalLeaveNormal}</td>
                    <td>${totalLeaveGolden}</td>
                    <td><button class="remove-btn">Remove</button></td>
                `;

                // Append the new row to the employee list (UI remains the same)
                const employeeList = document.getElementById('employee-list');
                employeeList.appendChild(newRow);

                // Create new employee data object (structure remains the same)
                const newEmployee = {
                    name: empName,
                    code: empCode,
                    role: empRole,
                    empMDRT: empMDRT,
                    leaveNormal: totalLeaveNormal,
                    leaveGolden: totalLeaveGolden,
                    remainingLeaveNormal: totalLeaveNormal,
                    remainingLeaveGolden: totalLeaveGolden,
                    applications: [],
                    leaveUsage: {
                        sickLeaveDays: 0,
                        forceMajeureDays: 0,
                        overseasDays: 0
                    }
                };

                try {
                    // Update both localStorage and Firebase
                    const savedEmployeeData = localStorage.getItem('employeeData');
                    const employeeData = savedEmployeeData ? JSON.parse(savedEmployeeData) : [];
                    employeeData.push(newEmployee);
                    
                    // Update localStorage (keeping original functionality)
                    localStorage.setItem('employeeData', JSON.stringify(employeeData));

                    // Update Firebase (adding real-time sync)
                    await db.collection('systemData').doc('employeeData').set({
                        value: JSON.stringify(employeeData),
                        timestamp: new Date()
                    });

                    // Clear input fields (keeping original functionality)
                    empNameInput.value = '';
                    empCodeInput.value = '';
                    document.getElementById('emp-mdrt').selectedIndex = 0;
                    document.getElementById('emp-role').selectedIndex = 0;
                    validateAddEmployeeForm();
                    
                    updatePenaltyEmployeeSelect();

                } catch (error) {
                    console.error('Error saving employee data:', error);
                    // If Firebase update fails, keep localStorage update
                    // This ensures the system continues to work even if Firebase is unavailable
                }
            });

            // Add Firebase real-time listener for updates from other clients
            db.collection('systemData').doc('employeeData')
                .onSnapshot((doc) => {
                    if (doc.exists && doc.data()) {
                        const firebaseData = JSON.parse(doc.data().value);
                        
                        // Update localStorage to match Firebase
                        localStorage.setItem('employeeData', JSON.stringify(firebaseData));
                        
                        // Update UI to reflect changes
                        const employeeList = document.getElementById('employee-list');
                        employeeList.innerHTML = ''; // Clear current list
                        
                        firebaseData.forEach(employee => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${employee.name}</td>
                                <td>${employee.code}</td>
                                <td>
                                    <select class="role-select" onchange="updateEmployeeRole(this)">
                                        <option value="Agent" ${employee.role === 'Agent' ? 'selected' : ''}>Agent</option>
                                        <option value="AUM/UM" ${employee.role === 'AUM/UM' ? 'selected' : ''}>AUM/UM</option>
                                        <option value="SUM" ${employee.role === 'SUM' ? 'selected' : ''}>SUM</option>
                                        <option value="BM" ${employee.role === 'BM' ? 'selected' : ''}>BM</option>
                                        <option value="DM" ${employee.role === 'DM' ? 'selected' : ''}>DM</option>
                                        <option value="DD" ${employee.role === 'DD' ? 'selected' : ''}>DD</option>
                                    </select>
                                </td>
                                <td>
                                    <select class="mdrt-select" onchange="updateEmployeeMDRT(this)">
                                        <option value="no" ${employee.empMDRT === 'no' ? 'selected' : ''}>NO</option>
                                        <option value="mdrt" ${employee.empMDRT === 'mdrt' ? 'selected' : ''}>MDRT</option>
                                        <option value="cot or above" ${employee.empMDRT === 'cot or above' ? 'selected' : ''}>COT or above</option>
                                    </select>
                                </td>
                                <td>${employee.leaveNormal}</td>
                                <td>${employee.leaveGolden}</td>
                                <td><button class="remove-btn">Remove</button></td>
                            `;
                            employeeList.appendChild(row);
                        });
                        
                        updatePenaltyEmployeeSelect();
                    }
                }, (error) => {
                    console.error("Error getting real-time updates:", error);
                    // System continues to work with localStorage if Firebase fails
                });

            // Add event listener for removing an employee
            const employeeList = document.getElementById('employee-list');
            employeeList.addEventListener('click', async function(event) {
                if (event.target.classList.contains('remove-btn')) {
                    try {
                        const row = event.target.closest('tr');
                        const employeeName = row.cells[0].textContent;
                        
                        // Remove employee row (UI remains the same)
                        row.remove();

                        // Update both localStorage and Firebase
                        // Employee Data Update
                        const savedEmployeeData = localStorage.getItem('employeeData');
                        if (savedEmployeeData) {
                            const employeeData = JSON.parse(savedEmployeeData);
                            const updatedEmployeeData = employeeData.filter(employee => employee.name !== employeeName);
                            
                            // Update localStorage
                            localStorage.setItem('employeeData', JSON.stringify(updatedEmployeeData));
                            
                            // Update Firebase
                            await db.collection('systemData').doc('employeeData').set({
                                value: JSON.stringify(updatedEmployeeData),
                                timestamp: new Date()
                            });
                        }

                        // Penalty Data Update
                        const savedPenalties = localStorage.getItem('penaltyData');
                        if (savedPenalties) {
                            const penalties = JSON.parse(savedPenalties);
                            const updatedPenalties = penalties.filter(penalty => penalty.employeeName !== employeeName);
                            
                            // Update localStorage
                            localStorage.setItem('penaltyData', JSON.stringify(updatedPenalties));
                            
                            // Update Firebase
                            await db.collection('systemData').doc('penaltyData').set({
                                value: JSON.stringify(updatedPenalties),
                                timestamp: new Date()
                            });
                            
                            // Refresh the penalty table
                            refreshPenaltyTable(updatedPenalties);
                        }

                        // Update the penalty employee select dropdown
                        updatePenaltyEmployeeSelect();

                    } catch (error) {
                        console.error('Error removing employee:', error);
                        // System continues to work with localStorage if Firebase fails
                    }
                }
            });
            
            async function loadEmployeePenalties(employeeName) {
                try {
                    const employeePenaltyList = document.getElementById('employee-penalty-list');
                    const penaltySumElement = document.getElementById('penalty-sum');
                    if (!employeePenaltyList || !penaltySumElement) return;

                    employeePenaltyList.innerHTML = '';
                    let totalPenalty = 0;

                    // Get penalties from Firebase, fallback to localStorage
                    const penaltyDoc = await db.collection('systemData').doc('penaltyData').get();
                    const penalties = penaltyDoc.exists ? 
                        JSON.parse(penaltyDoc.data().value) : 
                        JSON.parse(localStorage.getItem('penaltyData') || '[]');

                    const employeePenalties = penalties.filter(penalty => penalty.employeeName === employeeName);

                    if (employeePenalties.length === 0) {
                        employeePenaltyList.innerHTML = `
                            <tr><td colspan="6" style="text-align: center;">No penalties found</td></tr>
                        `;
                        penaltySumElement.textContent = '0';
                        return;
                    }

                    employeePenalties.forEach((penalty, index) => {
                        const isPast = isPastDeadline(penalty.deadline);
                        const finalAmount = (isPast && !penalty.cancelDouble) ? penalty.amount * 2 : penalty.amount;

                        if (!penalty.submitted) {
                            totalPenalty += finalAmount;
                        }

                        const newRow = document.createElement('tr');
                        newRow.innerHTML = `
                            <td>${penalty.date}</td>
                            <td>${penalty.reason}</td>
                            <td>${penalty.lateMinutes === 'No Show' ? 'No Show' : penalty.lateMinutes}</td>
                            <td>$${finalAmount}${(isPast && !penalty.cancelDouble) ? ' (Doubled)' : ''}</td>
                            <td>${penalty.deadline}</td>
                            <td>
                                ${penalty.submitted ? 
                                    `<span class="status-submitted">Submitted</span>` : 
                                    `<span class="status-not-submitted">Not Submitted</span><br>
                                    <button class="submit-proof-btn" data-index="${index}">Submit Proof</button>`
                                }
                            </td>
                        `;
                        if (isPast && !penalty.cancelDouble) {
                            newRow.style.backgroundColor = '#ffebee';
                        }
                        employeePenaltyList.appendChild(newRow);
                    });

                    penaltySumElement.textContent = totalPenalty;

                } catch (error) {
                    console.error('Error loading penalties:', error);
                    // Fallback to localStorage if Firebase fails
                    const savedPenalties = localStorage.getItem('penaltyData');
                    if (savedPenalties) {
                        const penalties = JSON.parse(savedPenalties);
                        const employeePenalties = penalties.filter(penalty => penalty.employeeName === employeeName);
                        
                        if (employeePenalties.length === 0) {
                            employeePenaltyList.innerHTML = `
                                <tr><td colspan="6" style="text-align: center;">No penalties found</td></tr>
                            `;
                            penaltySumElement.textContent = '0';
                            return;
                        }

                        employeePenalties.forEach((penalty, index) => {
                            const isPast = isPastDeadline(penalty.deadline);
                            const finalAmount = (isPast && !penalty.cancelDouble) ? penalty.amount * 2 : penalty.amount;

                            if (!penalty.submitted) {
                                totalPenalty += finalAmount;
                            }

                            const newRow = document.createElement('tr');
                            newRow.innerHTML = `
                                <td>${penalty.date}</td>
                                <td>${penalty.reason}</td>
                                <td>${penalty.lateMinutes === 'No Show' ? 'No Show' : penalty.lateMinutes}</td>
                                <td>$${finalAmount}${(isPast && !penalty.cancelDouble) ? ' (Doubled)' : ''}</td>
                                <td>${penalty.deadline}</td>
                                <td>
                                    ${penalty.submitted ? 
                                        `<span class="status-submitted">Submitted</span>` : 
                                        `<span class="status-not-submitted">Not Submitted</span><br>
                                        <button class="submit-proof-btn" data-index="${index}">Submit Proof</button>`
                                    }
                                </td>
                            `;
                            if (isPast && !penalty.cancelDouble) {
                                newRow.style.backgroundColor = '#ffebee';
                            }
                            employeePenaltyList.appendChild(newRow);
                        });

                        penaltySumElement.textContent = totalPenalty;
                    }
                }
            }

            // Handle proof submission
            async function handleProofSubmission(employeeName, penaltyIndex) {
                const fileInput = document.getElementById('proof-upload');
                fileInput.click();

                fileInput.onchange = async function() {
                    const file = fileInput.files[0];
                    if (file) {
                        if (file.size > 5242880) {
                            alert('File is too large. Please select an image under 5MB.');
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            await updatePenaltyStatus(employeeName, penaltyIndex, e.target.result);
                        };
                        reader.readAsDataURL(file);
                    }
                };
            }

            // Update penalty status
            async function updatePenaltyStatus(employeeName, penaltyIndex, proofImage) {
                try {
                    const penaltyDoc = await db.collection('systemData').doc('penaltyData').get();
                    const savedPenalties = penaltyDoc.exists ? 
                        JSON.parse(penaltyDoc.data().value) : 
                        JSON.parse(localStorage.getItem('penaltyData') || '[]');

                    const penaltyToUpdate = savedPenalties.find((penalty, index) => 
                        penalty.employeeName === employeeName && index === parseInt(penaltyIndex)
                    );

                    if (penaltyToUpdate) {
                        penaltyToUpdate.submitted = true;
                        penaltyToUpdate.proofImage = proofImage;
                        
                        // Update both localStorage and Firebase
                        localStorage.setItem('penaltyData', JSON.stringify(savedPenalties));
                        await db.collection('systemData').doc('penaltyData').set({
                            value: JSON.stringify(savedPenalties),
                            timestamp: new Date()
                        });
                        
                        // Refresh the display
                        loadEmployeePenalties(employeeName);
                    }
                } catch (error) {
                    console.error('Error updating penalty status:', error);
                    // System continues to work with localStorage if Firebase fails
                }
            }

            // Add Firebase real-time listeners
            function initializePenaltyListeners() {
                db.collection('systemData').doc('penaltyData')
                    .onSnapshot((doc) => {
                        if (doc.exists) {
                            const penalties = JSON.parse(doc.data().value);
                            localStorage.setItem('penaltyData', JSON.stringify(penalties));
                            refreshPenaltyTable(penalties);
                        }
                    }, (error) => {
                        console.error("Error getting real-time updates:", error);
                        // System continues to work with localStorage if Firebase fails
                    });
            }

            // Initialize listeners when the page loads
            document.addEventListener('DOMContentLoaded', function() {
                initializePenaltyListeners();
            });

            // View proof image function with enhanced error handling
            async function viewProof(proofImage) {
                try {
                    // Create modal container
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.8);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 1000;
                    `;

                    // Create loading indicator
                    const loadingSpinner = document.createElement('div');
                    loadingSpinner.style.cssText = `
                        color: white;
                        font-size: 20px;
                        text-align: center;
                    `;
                    loadingSpinner.textContent = 'Loading image...';
                    modal.appendChild(loadingSpinner);
                    document.body.appendChild(modal);

                    // Create and setup image
                    const img = document.createElement('img');
                    
                    img.onload = () => {
                        modal.removeChild(loadingSpinner);
                        modal.appendChild(img);
                    };

                    img.onerror = () => {
                        modal.removeChild(loadingSpinner);
                        modal.innerHTML = '<div style="color: white; padding: 20px;">Error loading image. Click anywhere to close.</div>';
                    };

                    img.style.cssText = `
                        max-width: 90%;
                        max-height: 90%;
                        object-fit: contain;
                    `;

                    // Set image source
                    if (proofImage.startsWith('data:')) {
                        // Handle base64 images (localStorage)
                        img.src = proofImage;
                    } else {
                        // Handle Firebase Storage URLs if needed in the future
                        img.src = proofImage;
                    }

                    // Add close functionality
                    modal.onclick = () => {
                        document.body.removeChild(modal);
                    };

                } catch (error) {
                    console.error('Error viewing proof:', error);
                    alert('Error displaying image. Please try again.');
                }
            }

            // Helper function to check if a date is past deadline
            // This function remains exactly the same as it's a pure utility function
            function isPastDeadline(deadline) {
                const today = new Date();
                const deadlineDate = new Date(deadline);
                today.setHours(0, 0, 0, 0);
                deadlineDate.setHours(0, 0, 0, 0);
                return today > deadlineDate;
            }

            // Optional: Add a helper function for date validation
            function isValidDate(dateString) {
                const date = new Date(dateString);
                return date instanceof Date && !isNaN(date);
            }

            // Add event listener for removing penalties
            document.addEventListener('click', async function(event) {
                if (event.target.classList.contains('cancel-double-btn')) {
                    if (confirm('Are you sure you want to cancel the double penalty?')) {
                        try {
                            const index = parseInt(event.target.getAttribute('data-index'));
                            
                            // Get penalties from Firebase, fallback to localStorage
                            let penalties;
                            try {
                                const penaltyDoc = await db.collection('systemData').doc('penaltyData').get();
                                penalties = penaltyDoc.exists ? 
                                    JSON.parse(penaltyDoc.data().value) : 
                                    JSON.parse(localStorage.getItem('penaltyData') || '[]');
                            } catch (error) {
                                console.error('Error fetching from Firebase:', error);
                                // Fallback to localStorage
                                penalties = JSON.parse(localStorage.getItem('penaltyData') || '[]');
                            }
                            
                            if (penalties) {
                                // Set cancelDouble flag for this penalty
                                penalties[index].cancelDouble = true;
                                
                                // Update both localStorage and Firebase
                                localStorage.setItem('penaltyData', JSON.stringify(penalties));
                                
                                try {
                                    await db.collection('systemData').doc('penaltyData').set({
                                        value: JSON.stringify(penalties),
                                        timestamp: new Date()
                                    });
                                } catch (error) {
                                    console.error('Error updating Firebase:', error);
                                    // Continue with localStorage updates even if Firebase fails
                                }
                                
                                // Refresh both admin and employee penalty tables
                                refreshPenaltyTable(penalties);
                                
                                // If we're in employee view, update that too
                                const currentEmployeeName = document.getElementById('employee-name')?.textContent;
                                if (currentEmployeeName === penalties[index].employeeName) {
                                    loadEmployeePenalties(currentEmployeeName);
                                }
                            }
                        } catch (error) {
                            console.error('Error canceling double penalty:', error);
                            alert('There was an error updating the penalty. Please try again.');
                        }
                    }
                }
            });

            // Function for viewing proof images with enhanced error handling
            function viewProof(proofImage) {
                try {
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.8);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 1000;
                    `;

                    // Add loading indicator
                    const loadingSpinner = document.createElement('div');
                    loadingSpinner.style.cssText = `
                        color: white;
                        font-size: 20px;
                        text-align: center;
                    `;
                    loadingSpinner.textContent = 'Loading image...';
                    modal.appendChild(loadingSpinner);
                    document.body.appendChild(modal);

                    const img = document.createElement('img');
                    
                    img.onload = () => {
                        modal.removeChild(loadingSpinner);
                        modal.appendChild(img);
                    };

                    img.onerror = () => {
                        modal.removeChild(loadingSpinner);
                        modal.innerHTML = '<div style="color: white; padding: 20px;">Error loading image. Click anywhere to close.</div>';
                    };

                    img.style.cssText = `
                        max-width: 90%;
                        max-height: 90%;
                        object-fit: contain;
                    `;

                    img.src = proofImage;

                    modal.onclick = () => {
                        document.body.removeChild(modal);
                    };

                } catch (error) {
                    console.error('Error viewing proof:', error);
                    alert('Error displaying image. Please try again.');
                }
            }

            // Add Firebase real-time listener for penalty updates
            function initializePenaltyListener() {
                db.collection('systemData').doc('penaltyData')
                    .onSnapshot((doc) => {
                        if (doc.exists && doc.data()) {
                            const penalties = JSON.parse(doc.data().value);
                            
                            // Update localStorage
                            localStorage.setItem('penaltyData', JSON.stringify(penalties));
                            
                            // Refresh penalty tables
                            refreshPenaltyTable(penalties);
                            
                            // Update employee view if active
                            const currentEmployeeName = document.getElementById('employee-name')?.textContent;
                            if (currentEmployeeName) {
                                loadEmployeePenalties(currentEmployeeName);
                            }
                        }
                    }, (error) => {
                        console.error("Error getting real-time updates:", error);
                        // System continues to work with localStorage if Firebase fails
                    });
            }

            // Initialize listener when the page loads
            document.addEventListener('DOMContentLoaded', function() {
                initializePenaltyListener();
            });

            // Add event listener for updating annual leave days
            employeeList.addEventListener('click', async function(event) {
                if (event.target.classList.contains('increment-btn') || event.target.classList.contains('decrement-btn')) {
                    try {
                        const leaveCell = event.target.parentNode;
                        const leaveDays = leaveCell.querySelector('.leave-days');
                        const currentDays = parseInt(leaveDays.textContent);
                        
                        if (event.target.classList.contains('increment-btn')) {
                            leaveDays.textContent = currentDays + 1;
                        } else if (currentDays > 0) {
                            leaveDays.textContent = currentDays - 1;
                        } else {
                            return; // Don't proceed if trying to decrement 0
                        }

                        // Create updated employee data
                        const employeeData = Array.from(employeeList.getElementsByTagName('tr')).map(row => {
                            const cells = row.getElementsByTagName('td');
                            return {
                                name: cells[0].textContent,
                                code: cells[1].textContent,
                                leave: cells[2].querySelector('.leave-days').textContent,
                                applications: []
                            };
                        });

                        // Update both localStorage and Firebase
                        localStorage.setItem('employeeData', JSON.stringify(employeeData));
                        
                        try {
                            await db.collection('systemData').doc('employeeData').set({
                                value: JSON.stringify(employeeData),
                                timestamp: new Date()
                            });
                        } catch (error) {
                            console.error('Error updating Firebase:', error);
                            // Continue with localStorage updates even if Firebase fails
                        }

                    } catch (error) {
                        console.error('Error updating leave days:', error);
                        alert('Error updating leave days. Please try again.');
                    }
                }
            });

            // Employee page functionality
            const applyLeaveForm = document.getElementById('apply-leave-form');
            const applicationStatusTable = document.getElementById('application-status-table');

            // Add a global variable to store the Google Drive link
            let googleDriveLink = 'https://drive.google.com/drive/u/0/folders/1_rRtXV55YEZAE-tuhpTbKITwjKzPJD6F';

            // Update the event listener for the leave type dropdown
            document.getElementById('leave-type').addEventListener('change', function() {
                const proofContainer = document.getElementById('proof-container');
                const proofFileInput = document.getElementById('proof-file');
                const forceMajeureOptions = document.getElementById('force-majeure-options');
                const forceMajeureReasonSelect = document.getElementById('force-majeure-reason');

                if (this.value === 'Sick Leave' || this.value === '不可抗力因素' || this.value === '離港') {
                    proofContainer.style.display = 'block';
                    proofFileInput.disabled = false;
                    proofFileInput.required = true;

                    if (this.value === '不可抗力因素') {
                        forceMajeureOptions.style.display = 'block';
                        forceMajeureReasonSelect.required = true;
                    } else {
                        forceMajeureOptions.style.display = 'none';
                        forceMajeureReasonSelect.required = false;
                    }
                } else {
                    proofContainer.style.display = 'none';
                    proofFileInput.disabled = true;
                    proofFileInput.required = false;
                    forceMajeureOptions.style.display = 'none';
                    forceMajeureReasonSelect.required = false;
                }
            });

            // Add Firebase real-time listener for employee data updates
            function initializeEmployeeDataListener() {
                db.collection('systemData').doc('employeeData')
                    .onSnapshot((doc) => {
                        if (doc.exists && doc.data()) {
                            const employeeData = JSON.parse(doc.data().value);
                            
                            // Update localStorage
                            localStorage.setItem('employeeData', JSON.stringify(employeeData));
                            
                            // Update UI if needed
                            updateEmployeeList(employeeData);
                        }
                    }, (error) => {
                        console.error("Error getting real-time updates:", error);
                        // System continues to work with localStorage if Firebase fails
                    });
            }

            // Helper function to update employee list UI
            function updateEmployeeList(employeeData) {
                const rows = employeeList.getElementsByTagName('tr');
                employeeData.forEach((employee, index) => {
                    if (rows[index]) {
                        const leaveDays = rows[index].querySelector('.leave-days');
                        if (leaveDays) {
                            leaveDays.textContent = employee.leave;
                        }
                    }
                });
            }

            // Initialize listener when the page loads
            document.addEventListener('DOMContentLoaded', function() {
                initializeEmployeeDataListener();
            });
            
            // Update the event listener for submitting the leave application form
            applyLeaveForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const applyDate = new Date();
                const leaveStartDate = new Date(document.getElementById('leave-start-date').value);
                const leaveEndDate = new Date(document.getElementById('leave-end-date').value);
                const leaveType = document.getElementById('leave-type').value;

                try {
                    // Validation for Annual Leave (Normal)
                    if (leaveType === 'Annual Leave (Normal)') {
                        const minLeaveStartDate = new Date(applyDate);
                        minLeaveStartDate.setDate(minLeaveStartDate.getDate() + 1);

                        if (leaveStartDate < minLeaveStartDate) {
                            alert("Leave Start Date must be at least 3 days after Apply Date for Annual Leave (Normal). (Include Apply Date)");
                            return;
                        }
                    } 
                    // Validation for other leave types
                    else if (leaveType === 'Annual Leave (黃金事假)' || leaveType === 'Sick Leave' || leaveType === '不可抗力因素') {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const startDate = new Date(leaveStartDate);
                        startDate.setHours(0, 0, 0, 0);
                        
                        if (startDate < today) {
                            alert("Leave Start Date cannot be earlier than today.");
                            return;
                        }
                    }

                    // General date validation
                    if (leaveEndDate < leaveStartDate) {
                        alert("Leave End Date must be on or after Leave Start Date.");
                        return;
                    }

                    // Handle proof file for specific leave types
                    if (leaveType === 'Sick Leave' || leaveType === '不可抗力因素' || leaveType === '離港') {
                        const proofFile = document.getElementById('proof-file').files[0];
                        if (!proofFile) {
                            alert(`Please submit proof for ${leaveType}.`);
                            return;
                        }

                        // File size validation (e.g., 5MB limit)
                        if (proofFile.size > 5 * 1024 * 1024) {
                            alert('Proof file size must be less than 5MB');
                            return;
                        }

                        // Read proof file as data URL
                        const reader = new FileReader();
                        reader.onloadend = async function() {
                            try {
                                const proofDataUrl = reader.result;
                                await processLeaveApplication(applyDate, leaveStartDate, leaveEndDate, leaveType, proofDataUrl);
                            } catch (error) {
                                console.error('Error processing leave application:', error);
                                alert('Error submitting leave application. Please try again.');
                            }
                        };
                        reader.onerror = function() {
                            alert('Error reading proof file. Please try again.');
                        };
                        reader.readAsDataURL(proofFile);
                    } else {
                        await processLeaveApplication(applyDate, leaveStartDate, leaveEndDate, leaveType, null);
                    }

                } catch (error) {
                    console.error('Error in leave application submission:', error);
                    alert('Error submitting leave application. Please try again.');
                }
            });

            async function processLeaveApplication(applyDate, leaveStartDate, leaveEndDate, leaveType, proofDataUrl) {
                try {
                    // Calculate leave days
                    const leaveDays = Math.ceil((leaveEndDate - leaveStartDate) / (1000 * 60 * 60 * 24)) + 1;
                    const remainingLeaveNormal = document.getElementById('remaining-leave-normal').textContent;
                    const remainingLeaveGolden = document.getElementById('remaining-leave-golden').textContent;

                    // Check leave balance - skip check if unlimited leaves (∞)
                    if (leaveType === 'Annual Leave (Normal)') {
                        if (remainingLeaveNormal !== '∞' && leaveDays > parseInt(remainingLeaveNormal)) {
                            alert("Insufficient Annual Leave balance.");
                            return;
                        }
                    } else if (leaveType === 'Annual Leave (黃金事假)') {
                        if ((remainingLeaveGolden !== '∞' && leaveDays > parseInt(remainingLeaveGolden)) || 
                            (remainingLeaveNormal !== '∞' && leaveDays > parseInt(remainingLeaveNormal))) {
                            alert("Insufficient Leave balance.");
                            return;
                        }
                    }

                    // Get employee data from Firebase, fallback to localStorage
                    let employeeData;
                    try {
                        const employeeDoc = await db.collection('systemData').doc('employeeData').get();
                        employeeData = employeeDoc.exists ? 
                            JSON.parse(employeeDoc.data().value) : 
                            JSON.parse(localStorage.getItem('employeeData') || '[]');
                    } catch (error) {
                        console.error('Error fetching from Firebase:', error);
                        employeeData = JSON.parse(localStorage.getItem('employeeData') || '[]');
                    }

                    const loggedInEmployee = employeeData.find(employee => employee.name === employeeName.textContent);
                    
                    if (loggedInEmployee) {
                        // Update remaining leaves - only if not unlimited
                        if (leaveType === 'Annual Leave (Normal)' && remainingLeaveNormal !== '∞') {
                            loggedInEmployee.remainingLeaveNormal = parseInt(remainingLeaveNormal) - leaveDays;
                            document.getElementById('remaining-leave-normal').textContent = loggedInEmployee.remainingLeaveNormal;
                        } else if (leaveType === 'Annual Leave (黃金事假)' && remainingLeaveGolden !== '∞') {
                            loggedInEmployee.remainingLeaveGolden = parseInt(remainingLeaveGolden) - leaveDays;
                            loggedInEmployee.remainingLeaveNormal = parseInt(remainingLeaveNormal) - leaveDays;
                            document.getElementById('remaining-leave-golden').textContent = loggedInEmployee.remainingLeaveGolden;
                            document.getElementById('remaining-leave-normal').textContent = loggedInEmployee.remainingLeaveNormal;
                        }

                        // Format the apply date
                        const formattedApplyDate = formatDate(applyDate);

                        // Create the application object
                        const newApplication = {
                            applyDate: formattedApplyDate,
                            leaveStartDate: leaveStartDate.toLocaleDateString(),
                            leaveEndDate: leaveEndDate.toLocaleDateString(),
                            leaveType: leaveType,
                            status: 'Approved',
                            proofDataUrl: proofDataUrl,
                            timestamp: new Date().toISOString() // Add timestamp for sorting
                        };

                        // Add to employee's applications
                        if (!loggedInEmployee.applications) {
                            loggedInEmployee.applications = [];
                        }
                        loggedInEmployee.applications.push(newApplication);
                        
                        // Update leave usage counts
                        updateLeaveUsageCounts(loggedInEmployee.name);
                        
                        // Update both localStorage and Firebase
                        localStorage.setItem('employeeData', JSON.stringify(employeeData));
                        
                        try {
                            await db.collection('systemData').doc('employeeData').set({
                                value: JSON.stringify(employeeData),
                                timestamp: new Date()
                            });
                        } catch (error) {
                            console.error('Error updating Firebase:', error);
                            // Continue with local updates if Firebase fails
                        }

                        // Add single row to application status table
                        const newRow = document.createElement('tr');
                        newRow.setAttribute('data-employee', employeeName.textContent);
                        newRow.innerHTML = `
                            <td>${formattedApplyDate}</td>
                            <td>${leaveStartDate.toLocaleDateString()}</td>
                            <td>${leaveEndDate.toLocaleDateString()}</td>
                            <td>${leaveType}</td>
                            <td>Approved</td>
                            ${proofDataUrl ? `<td><button class="show-proof-btn" data-proof="${proofDataUrl}">Show</button></td>` : ''}
                        `;
                        applicationStatusTable.appendChild(newRow);

                        // Recreate pagination after adding new row
                        createPagination('application-status-table');

                        // Clear form fields
                        document.getElementById('apply-date').value = '';
                        document.getElementById('leave-start-date').value = '';
                        document.getElementById('leave-end-date').value = '';
                        document.getElementById('leave-type').selectedIndex = 0;
                        document.getElementById('proof-container').style.display = 'none';
                        document.getElementById('force-majeure-options').style.display = 'none';

                        // Show success message
                        alert('Leave application submitted successfully!');
                    }

                } catch (error) {
                    console.error('Error processing leave application:', error);
                    alert('Error submitting leave application. Please try again.');
                }
            }

            // Add Firebase real-time listener for leave application updates
            function initializeLeaveApplicationListener() {
                db.collection('systemData').doc('employeeData')
                    .onSnapshot((doc) => {
                        if (doc.exists && doc.data()) {
                            const employeeData = JSON.parse(doc.data().value);
                            
                            // Update localStorage
                            localStorage.setItem('employeeData', JSON.stringify(employeeData));
                            
                            // Update UI only if current employee's data changed
                            const currentEmployee = employeeData.find(emp => emp.name === employeeName.textContent);
                            if (currentEmployee) {
                                // Update leave counters
                                if (document.getElementById('remaining-leave-normal')) {
                                    document.getElementById('remaining-leave-normal').textContent = 
                                        currentEmployee.remainingLeaveNormal || '∞';
                                }
                                if (document.getElementById('remaining-leave-golden')) {
                                    document.getElementById('remaining-leave-golden').textContent = 
                                        currentEmployee.remainingLeaveGolden || '∞';
                                }
                                
                                // Update application table
                                updateApplicationTable(currentEmployee.applications);
                            }
                        }
                    }, (error) => {
                        console.error("Error getting real-time updates:", error);
                        // System continues to work with localStorage if Firebase fails
                    });
            }

            // Initialize listener when the page loads
            document.addEventListener('DOMContentLoaded', function() {
                initializeLeaveApplicationListener();
            });

            // Helper function to format date
            function formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                
                // Determine if it's AM or PM in Traditional Chinese
                const period = date.getHours() >= 12 ? '下午' : '上午';
                
                return `${year}/${month}/${day} ${period}${hours}:${minutes}:${seconds}`;
            }

            // Function to upload proof file to both Google Drive and Firebase Storage
            async function uploadToGoogleDrive(file, accessToken) {
                try {
                    // First, upload to Google Drive as before
                    if (googleDriveLink && accessToken) {
                        const formData = new FormData();
                        formData.append('metadata', new Blob([JSON.stringify({ 
                            name: file.name,
                            timestamp: new Date().toISOString()
                        })], { type: 'application/json' }));
                        formData.append('file', file);

                        try {
                            const response = await fetch(googleDriveLink, {
                                method: 'POST',
                                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                                body: formData
                            });
                            
                            const data = await response.json();
                            console.log('File uploaded to Google Drive. File ID:', data.id);

                            // Store file reference in Firebase
                            try {
                                await db.collection('fileUploads').add({
                                    googleDriveId: data.id,
                                    fileName: file.name,
                                    uploadDate: new Date().toISOString(),
                                    fileType: file.type,
                                    fileSize: file.size,
                                    uploadedBy: getCurrentUser() // Your function to get current user
                                });
                            } catch (firebaseError) {
                                console.error('Error storing file reference in Firebase:', firebaseError);
                                // Continue even if Firebase storage fails
                            }

                            return data.id; // Return the Google Drive file ID

                        } catch (error) {
                            console.error('Error uploading file to Google Drive:', error);
                            throw error;
                        }
                    } else {
                        console.warn('Google Drive link or access token missing. File not uploaded.');
                        return null;
                    }
                } catch (error) {
                    console.error('Error in upload process:', error);
                    throw error;
                }
            }

            // Helper function to get file metadata from Firebase
            async function getFileMetadata(fileId) {
                try {
                    const fileDoc = await db.collection('fileUploads')
                        .where('googleDriveId', '==', fileId)
                        .get();
                    
                    if (!fileDoc.empty) {
                        return fileDoc.docs[0].data();
                    }
                    return null;
                } catch (error) {
                    console.error('Error getting file metadata:', error);
                    return null;
                }
            }

            // Helper function to track file access
            async function trackFileAccess(fileId, accessType = 'view') {
                try {
                    await db.collection('fileAccess').add({
                        fileId: fileId,
                        accessType: accessType,
                        accessedBy: getCurrentUser(), // Your function to get current user
                        accessDate: new Date().toISOString()
                    });
                } catch (error) {
                    console.error('Error tracking file access:', error);
                    // Continue even if tracking fails
                }
            }

            // Enhanced file upload function with progress tracking
            async function uploadFileWithProgress(file, accessToken, progressCallback) {
                try {
                    // Create upload task reference in Firebase
                    const uploadRef = await db.collection('uploadTasks').add({
                        fileName: file.name,
                        status: 'started',
                        progress: 0,
                        startTime: new Date().toISOString()
                    });

                    // Upload to Google Drive with progress updates
                    const driveFileId = await uploadToGoogleDrive(file, accessToken);

                    // Update upload task status
                    await uploadRef.update({
                        status: 'completed',
                        progress: 100,
                        completionTime: new Date().toISOString(),
                        driveFileId: driveFileId
                    });

                    return driveFileId;

                } catch (error) {
                    console.error('Error in upload process:', error);
                    
                    // Update upload task status on error
                    if (uploadRef) {
                        await uploadRef.update({
                            status: 'error',
                            errorMessage: error.message,
                            errorTime: new Date().toISOString()
                        });
                    }
                    
                    throw error;
                }
            }

            // Add Firebase real-time listener for file uploads
            function initializeFileUploadListener() {
                db.collection('uploadTasks')
                    .where('status', '==', 'inProgress')
                    .onSnapshot((snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'modified') {
                                const upload = change.doc.data();
                                // Update UI with upload progress if needed
                                updateUploadProgress(upload);
                            }
                        });
                    }, (error) => {
                        console.error("Error getting upload updates:", error);
                    });
            }

            // Helper function to update upload progress UI
            function updateUploadProgress(upload) {
                // Implementation depends on your UI
                const progressElement = document.querySelector(`[data-upload-id="${upload.id}"]`);
                if (progressElement) {
                    progressElement.style.width = `${upload.progress}%`;
                }
            }

            // Initialize listeners when the page loads
            document.addEventListener('DOMContentLoaded', function() {
                initializeFileUploadListener();
            });

            // Admin page functionality
            const applicationListBody = document.getElementById('application-list-body');

            // Function to show the proof image with Firebase tracking
            async function showProofImage(proofDataUrl, applicationId) {
                try {
                    // Remove any existing proof modal
                    const existingModal = document.querySelector('.proof-modal');
                    if (existingModal) {
                        existingModal.remove();
                    }

                    // Create modal container
                    const modal = document.createElement('div');
                    modal.className = 'proof-modal';
                    
                    // Create modal content
                    const modalContent = document.createElement('div');
                    modalContent.className = 'proof-modal-content';
                    
                    // Create close button
                    const closeBtn = document.createElement('span');
                    closeBtn.className = 'close-modal';
                    closeBtn.innerHTML = '&times;';
                    closeBtn.onclick = function() {
                        modal.style.display = 'none';
                        modal.remove();
                    };
                    
                    // Create loading indicator
                    const loadingSpinner = document.createElement('div');
                    loadingSpinner.className = 'loading-spinner';
                    loadingSpinner.textContent = 'Loading...';
                    modalContent.appendChild(loadingSpinner);
                    
                    // Create image
                    const img = document.createElement('img');
                    img.style.display = 'none'; // Hide until loaded
                    
                    img.onload = async function() {
                        loadingSpinner.remove();
                        img.style.display = 'block';
                        
                        // Log proof view in Firebase
                        try {
                            await db.collection('proofViews').add({
                                applicationId: applicationId,
                                viewedBy: getCurrentUser(), // Your function to get current user
                                viewedAt: new Date().toISOString(),
                                status: 'success'
                            });
                        } catch (error) {
                            console.error('Error logging proof view:', error);
                            // Continue even if logging fails
                        }
                    };

                    img.onerror = async function() {
                        loadingSpinner.textContent = 'Error loading image';
                        // Log error in Firebase
                        try {
                            await db.collection('proofViews').add({
                                applicationId: applicationId,
                                viewedBy: getCurrentUser(),
                                viewedAt: new Date().toISOString(),
                                status: 'error',
                                errorMessage: 'Failed to load image'
                            });
                        } catch (error) {
                            console.error('Error logging proof view error:', error);
                        }
                    };

                    img.src = proofDataUrl;
                    img.alt = 'Proof Image';
                    
                    // Assemble modal
                    modalContent.appendChild(closeBtn);
                    modalContent.appendChild(img);
                    modal.appendChild(modalContent);
                    document.body.appendChild(modal);
                    
                    // Show modal
                    modal.style.display = 'block';
                    
                    // Close modal when clicking outside
                    window.onclick = function(event) {
                        if (event.target === modal) {
                            modal.style.display = 'none';
                            modal.remove();
                        }
                    };

                } catch (error) {
                    console.error('Error showing proof image:', error);
                    alert('Error displaying proof image. Please try again.');
                }
            }

            // Event listener for the "Show" button clicks with Firebase integration
            applicationListBody.addEventListener('click', async function(event) {
                if (event.target.classList.contains('show-proof-btn')) {
                    try {
                        const proofDataUrl = event.target.getAttribute('data-proof');
                        const applicationId = event.target.getAttribute('data-application-id');

                        if (proofDataUrl) {
                            // Update real-time viewing status in Firebase
                            const viewingStatus = {
                                applicationId: applicationId,
                                viewerId: getCurrentUser(),
                                startTime: new Date().toISOString(),
                                status: 'viewing'
                            };

                            try {
                                const statusRef = await db.collection('activeViews').add(viewingStatus);
                                
                                // Show the proof image
                                await showProofImage(proofDataUrl, applicationId);
                                
                                // Update viewing status when done
                                await statusRef.update({
                                    endTime: new Date().toISOString(),
                                    status: 'completed'
                                });
                                
                            } catch (firebaseError) {
                                console.error('Error updating viewing status:', firebaseError);
                                // Continue with showing the image even if Firebase update fails
                                await showProofImage(proofDataUrl, applicationId);
                            }
                        } else {
                            alert('No proof available for this application.');
                        }
                    } catch (error) {
                        console.error('Error handling proof view:', error);
                        alert('Error viewing proof. Please try again.');
                    }
                }
            });

            // Add Firebase real-time listener for active views
            function initializeActiveViewsListener() {
                db.collection('activeViews')
                    .where('status', '==', 'viewing')
                    .onSnapshot((snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'added' || change.type === 'modified') {
                                updateViewingStatus(change.doc.data());
                            }
                        });
                    }, (error) => {
                        console.error("Error getting active views:", error);
                    });
            }

            // Helper function to update viewing status in UI
            function updateViewingStatus(viewData) {
                // Implementation depends on your UI requirements
                const statusIndicator = document.querySelector(
                    `[data-application-id="${viewData.applicationId}"] .viewing-status`
                );
                if (statusIndicator) {
                    statusIndicator.textContent = `Viewed by: ${viewData.viewerId}`;
                    statusIndicator.title = `Last viewed: ${new Date(viewData.startTime).toLocaleString()}`;
                }
            }

            // Initialize listener when the page loads
            document.addEventListener('DOMContentLoaded', function() {
                initializeActiveViewsListener();
            });

            // Add event listener for reject button clicks with Firebase integration
            applicationListBody.addEventListener('click', async function(event) {
                if (event.target.classList.contains('reject-btn')) {
                    try {
                        const employeeName = event.target.getAttribute('data-employee');
                        const applicationIndex = parseInt(event.target.getAttribute('data-index'));
                        
                        // Get employee data from Firebase, fallback to localStorage
                        let employeeData;
                        try {
                            const doc = await db.collection('systemData').doc('employeeData').get();
                            employeeData = doc.exists ? JSON.parse(doc.data().value) : JSON.parse(localStorage.getItem('employeeData'));
                        } catch (error) {
                            console.error('Error fetching from Firebase:', error);
                            employeeData = JSON.parse(localStorage.getItem('employeeData'));
                        }

                        const employee = employeeData.find(emp => emp.name === employeeName);
                        
                        if (employee && employee.applications[applicationIndex]) {
                            // Update the status to Rejected
                            employee.applications[applicationIndex].status = 'Rejected';
                            
                            // Calculate leave days to restore
                            const application = employee.applications[applicationIndex];
                            const leaveStartDate = new Date(application.leaveStartDate);
                            const leaveEndDate = new Date(application.leaveEndDate);
                            const leaveDays = Math.ceil((leaveEndDate - leaveStartDate) / (1000 * 60 * 60 * 24)) + 1;
                            
                            // Restore leave days based on type
                            if (application.leaveType === 'Annual Leave (Normal)') {
                                employee.remainingLeaveNormal += leaveDays;
                            } else if (application.leaveType === 'Annual Leave (黃金事假)') {
                                employee.remainingLeaveGolden += leaveDays;
                                employee.remainingLeaveNormal += leaveDays;
                            }
                            
                            // Update both localStorage and Firebase
                            localStorage.setItem('employeeData', JSON.stringify(employeeData));
                            
                            try {
                                await db.collection('systemData').doc('employeeData').set({
                                    value: JSON.stringify(employeeData),
                                    timestamp: new Date()
                                });

                                // Log rejection in Firebase
                                await db.collection('leaveActions').add({
                                    type: 'rejection',
                                    employeeName: employeeName,
                                    applicationIndex: applicationIndex,
                                    rejectedBy: getCurrentUser(),
                                    rejectedAt: new Date().toISOString(),
                                    application: application
                                });
                            } catch (error) {
                                console.error('Error updating Firebase:', error);
                                // Continue with local updates if Firebase fails
                            }
                            
                            // Update the UI
                            const statusCell = event.target.parentElement;
                            statusCell.innerHTML = 'Rejected';
                            
                            // Update leave usage counts
                            updateLeaveUsageCounts(employeeName);
                        }
                    } catch (error) {
                        console.error('Error processing rejection:', error);
                        alert('Error processing rejection. Please try again.');
                    }
                }
            });

            // Load employee data with Firebase integration
            async function loadEmployeeData() {
                try {
                    // Try to get data from Firebase first
                    let employeeData;
                    try {
                        const doc = await db.collection('systemData').doc('employeeData').get();
                        employeeData = doc.exists ? JSON.parse(doc.data().value) : JSON.parse(localStorage.getItem('employeeData'));
                    } catch (error) {
                        console.error('Error fetching from Firebase:', error);
                        employeeData = JSON.parse(localStorage.getItem('employeeData'));
                    }

                    if (employeeData) {
                        // Update employee list
                        const employeeList = document.getElementById('employee-list');
                        if (employeeList) {
                            employeeList.innerHTML = '';

                            employeeData.forEach(employee => {
                                const newRow = document.createElement('tr');
                                newRow.innerHTML = `
                                    <td>${employee.name}</td>
                                    <td>${employee.code}</td>
                                    <td>
                                        <select class="role-select" onchange="updateEmployeeRole(this)">
                                            <option value="Agent" ${employee.role === 'Agent' ? 'selected' : ''}>Agent</option>
                                            <option value="AUM/UM" ${employee.role === 'AUM/UM' ? 'selected' : ''}>AUM/UM</option>
                                            <option value="SUM" ${employee.role === 'SUM' ? 'selected' : ''}>SUM</option>
                                            <option value="BM" ${employee.role === 'BM' ? 'selected' : ''}>BM</option>
                                            <option value="DM" ${employee.role === 'DM' ? 'selected' : ''}>DM</option>
                                            <option value="DD" ${employee.role === 'DD' ? 'selected' : ''}>DD</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select class="mdrt-select" onchange="updateEmployeeMDRT(this)">
                                            <option value="no" ${employee.empMDRT === 'no' ? 'selected' : ''}>NO</option>
                                            <option value="mdrt" ${employee.empMDRT === 'mdrt' ? 'selected' : ''}>MDRT</option>
                                            <option value="cot or above" ${employee.empMDRT === 'cot or above' ? 'selected' : ''}>COT or above</option>
                                        </select>
                                    </td>
                                    <td>${employee.remainingLeaveNormal !== undefined ? employee.remainingLeaveNormal : employee.leaveNormal}</td>
                                    <td>${employee.remainingLeaveGolden !== undefined ? employee.remainingLeaveGolden : employee.leaveGolden}</td>
                                    <td><button class="remove-btn">Remove</button></td>
                                `;
                                employeeList.appendChild(newRow);
                            });
                        }

                        // Update logged in employee information
                        const employeeName = document.getElementById('employee-name');
                        if (employeeName && employeeName.textContent) {
                            const loggedInEmployee = employeeData.find(employee => employee.name === employeeName.textContent);
                            if (loggedInEmployee) {
                                updateEmployeeUI(loggedInEmployee);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading employee data:', error);
                    alert('Error loading employee data. Please refresh the page.');
                }
            }

            // Helper function to update employee UI
            function updateEmployeeUI(employee) {
                document.getElementById('employee-code').textContent = employee.code;
                document.getElementById('employee-role').textContent = employee.role;
                document.getElementById('employee-mdrt').textContent = employee.empMDRT.toUpperCase();
                document.getElementById('employee-leave-normal').textContent = employee.leaveNormal;
                document.getElementById('employee-leave-golden').textContent = employee.leaveGolden;
                document.getElementById('remaining-leave-normal').textContent = 
                    employee.remainingLeaveNormal !== undefined ? employee.remainingLeaveNormal : employee.leaveNormal;
                document.getElementById('remaining-leave-golden').textContent = 
                    employee.remainingLeaveGolden !== undefined ? employee.remainingLeaveGolden : employee.leaveGolden;

                // Update leave usage counts
                if (employee.leaveUsage) {
                    document.getElementById('used-sick-leave').textContent = employee.leaveUsage.sickLeaveDays;
                    document.getElementById('used-force-majeure').textContent = employee.leaveUsage.forceMajeureDays;
                    document.getElementById('used-overseas').textContent = employee.leaveUsage.overseasDays;
                }

                // Update application status table
                updateApplicationTable(employee);
            }

            // Helper function to update application table
            function updateApplicationTable(employee) {
                const applicationStatusTable = document.getElementById('application-status-table');
                if (applicationStatusTable && employee.applications) {
                    applicationStatusTable.innerHTML = `
                        <tr>
                            <th>Apply Date</th>
                            <th>Leave Start Date</th>
                            <th>Leave End Date</th>
                            <th>Leave Type</th>
                            <th>Status</th>
                        </tr>
                    `;

                    employee.applications.forEach(application => {
                        const newRow = document.createElement('tr');
                        newRow.setAttribute('data-employee', employee.name);
                        newRow.innerHTML = `
                            <td>${application.applyDate}</td>
                            <td>${application.leaveStartDate}</td>
                            <td>${application.leaveEndDate}</td>
                            <td>${application.leaveType}</td>
                            <td>${application.status}</td>
                        `;
                        applicationStatusTable.appendChild(newRow);
                    });
                }
            }

            // Add Firebase real-time listener
            function initializeDataListener() {
                db.collection('systemData').doc('employeeData')
                    .onSnapshot((doc) => {
                        if (doc.exists && doc.data()) {
                            const employeeData = JSON.parse(doc.data().value);
                            localStorage.setItem('employeeData', JSON.stringify(employeeData));
                            loadEmployeeData(); // Refresh UI with new data
                        }
                    }, (error) => {
                        console.error("Error getting real-time updates:", error);
                    });
            }

            // Initialize on page load
            window.addEventListener('load', function() {
                loadEmployeeData();
                initializeDataListener();
            });

            // Function to update the application list table with Firebase integration
            async function updateApplicationListTable() {
                try {
                    // Get employee data from Firebase, fallback to localStorage
                    let employeeData;
                    try {
                        const doc = await db.collection('systemData').doc('employeeData').get();
                        employeeData = doc.exists ? JSON.parse(doc.data().value) : JSON.parse(localStorage.getItem('employeeData'));
                    } catch (error) {
                        console.error('Error fetching from Firebase:', error);
                        employeeData = JSON.parse(localStorage.getItem('employeeData'));
                    }

                    const applicationListBody = document.getElementById('application-list-body');
                    if (applicationListBody && employeeData) {
                        applicationListBody.innerHTML = '';
                        
                        // Create an array of all applications with employee information
                        let allApplications = [];
                        employeeData.forEach(employee => {
                            if (employee.applications) {
                                employee.applications.forEach((application, index) => {
                                    allApplications.push({
                                        ...application,
                                        employeeName: employee.name,
                                        index: index,
                                        timestamp: application.timestamp || application.applyDate // For compatibility
                                    });
                                });
                            }
                        });

                        // Sort applications by date and time (newest first)
                        allApplications.sort((a, b) => {
                            // Split date and time parts
                            const [dateA, timeA] = a.applyDate.split(' ');
                            const [dateB, timeB] = b.applyDate.split(' ');

                            // Convert YYYY/MM/DD to Date objects
                            const [yearA, monthA, dayA] = dateA.split('/');
                            const [yearB, monthB, dayB] = dateB.split('/');
                            
                            const dateObjA = new Date(yearA, monthA - 1, dayA);
                            const dateObjB = new Date(yearB, monthB - 1, dayB);

                            // First compare dates
                            if (dateObjA.getTime() !== dateObjB.getTime()) {
                                return dateObjB.getTime() - dateObjA.getTime();
                            }

                            // If dates are equal, compare times
                            const periodA = timeA.slice(0, 2);
                            const periodB = timeB.slice(0, 2);
                            const timePartsA = timeA.slice(2).split(':');
                            const timePartsB = timeB.slice(2).split(':');

                            // Convert to 24-hour format
                            let hoursA = parseInt(timePartsA[0]);
                            let hoursB = parseInt(timePartsB[0]);

                            // Adjust hours for 下午 (PM)
                            if (periodA === '下午' && hoursA !== 12) hoursA += 12;
                            if (periodB === '下午' && hoursB !== 12) hoursB += 12;
                            if (periodA === '上午' && hoursA === 12) hoursA = 0;
                            if (periodB === '上午' && hoursB === 12) hoursB = 0;

                            // Compare hours, minutes, seconds
                            if (hoursA !== hoursB) return hoursB - hoursA;
                            const minutesA = parseInt(timePartsA[1]);
                            const minutesB = parseInt(timePartsB[1]);
                            if (minutesA !== minutesB) return minutesB - minutesA;
                            const secondsA = parseInt(timePartsA[2]);
                            const secondsB = parseInt(timePartsB[2]);
                            return secondsB - secondsA;
                        });

                        // Create rows for sorted applications
                        allApplications.forEach(application => {
                            const newRow = document.createElement('tr');
                            newRow.dataset.applicationIndex = application.index;
                            newRow.dataset.employeeName = application.employeeName;
                            newRow.innerHTML = `
                                <td>${application.employeeName}</td>
                                <td>${application.applyDate}</td>
                                <td>${application.leaveStartDate}</td>
                                <td>${application.leaveEndDate}</td>
                                <td>${application.leaveType}</td>
                                <td>
                                    ${application.status}
                                    ${application.status === 'Approved' ? 
                                        `<br><button class="reject-btn" data-employee="${application.employeeName}" data-index="${application.index}">Reject</button>` : 
                                        ''}
                                </td>
                                <td>${application.proofDataUrl ? '<button class="show-proof-btn" data-proof="' + application.proofDataUrl + '" data-application-id="' + application.index + '">Show</button>' : ''}</td>
                            `;
                            applicationListBody.appendChild(newRow);
                        });
                        
                        // Apply pagination after sorting and populating
                        createPagination('application-list-table');
                    }

                    // Initialize penalty section
                    initializePenaltySection();

                } catch (error) {
                    console.error('Error updating application list:', error);
                }
            }

            // Add Firebase real-time listener for application updates
            function initializeApplicationListener() {
                db.collection('systemData').doc('employeeData')
                    .onSnapshot((doc) => {
                        if (doc.exists && doc.data()) {
                            const employeeData = JSON.parse(doc.data().value);
                            localStorage.setItem('employeeData', JSON.stringify(employeeData));
                            updateApplicationListTable();
                        }
                    }, (error) => {
                        console.error("Error getting real-time updates:", error);
                    });
            }

            // Add listener for application status changes
            function initializeStatusChangeListener() {
                db.collection('applicationStatusChanges')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .onSnapshot((snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'added') {
                                const statusChange = change.doc.data();
                                updateApplicationStatus(statusChange);
                            }
                        });
                    }, (error) => {
                        console.error("Error getting status changes:", error);
                    });
            }

            // Helper function to update application status in UI
            function updateApplicationStatus(statusChange) {
                const row = document.querySelector(`tr[data-employee-name="${statusChange.employeeName}"][data-application-index="${statusChange.applicationIndex}"]`);
                if (row) {
                    const statusCell = row.querySelector('td:nth-child(6)');
                    if (statusCell) {
                        statusCell.innerHTML = `
                            ${statusChange.newStatus}
                            ${statusChange.newStatus === 'Approved' ? 
                                `<br><button class="reject-btn" data-employee="${statusChange.employeeName}" data-index="${statusChange.applicationIndex}">Reject</button>` : 
                                ''}
                        `;
                    }
                }
            }

            // Initialize on page load
            window.addEventListener('load', function() {
                updateApplicationListTable();
                initializeApplicationListener();
                initializeStatusChangeListener();
            });

            // Penalty form functionality
            const penaltyForm = document.getElementById('penalty-form');
            const penaltyEmployeeSelect = document.getElementById('penalty-employee');
            const penaltyList = document.getElementById('penalty-list');

            // Function to update employee select options with Firebase integration
            async function updatePenaltyEmployeeSelect() {
                try {
                    // Get employee data from Firebase, fallback to localStorage
                    let employeeData;
                    try {
                        const doc = await db.collection('systemData').doc('employeeData').get();
                        employeeData = doc.exists ? JSON.parse(doc.data().value) : JSON.parse(localStorage.getItem('employeeData'));
                    } catch (error) {
                        console.error('Error fetching from Firebase:', error);
                        employeeData = JSON.parse(localStorage.getItem('employeeData'));
                    }

                    if (employeeData) {
                        penaltyEmployeeSelect.innerHTML = '<option value="">Select Employee</option>';
                        employeeData.forEach(employee => {
                            const option = document.createElement('option');
                            option.value = employee.name;
                            option.textContent = employee.name;
                            penaltyEmployeeSelect.appendChild(option);
                        });

                        // Update Firebase with current penalty employee options
                        try {
                            await db.collection('systemData').doc('penaltyEmployees').set({
                                employees: employeeData.map(emp => emp.name),
                                lastUpdated: new Date().toISOString()
                            });
                        } catch (error) {
                            console.error('Error updating Firebase penalty employees:', error);
                            // Continue even if Firebase update fails
                        }
                    }
                } catch (error) {
                    console.error('Error updating penalty employee select:', error);
                }
            }

            // Function to format date (unchanged)
            function formatDateSimple(date) {
                const d = new Date(date);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // Function to calculate deadline (unchanged)
            function calculateDeadline(date) {
                const deadline = new Date(date);
                deadline.setDate(deadline.getDate() + 6);
                return formatDateSimple(deadline);
            }

            // Add Firebase real-time listener for employee data updates
            function initializePenaltyEmployeeListener() {
                db.collection('systemData').doc('employeeData')
                    .onSnapshot((doc) => {
                        if (doc.exists && doc.data()) {
                            const employeeData = JSON.parse(doc.data().value);
                            localStorage.setItem('employeeData', JSON.stringify(employeeData));
                            updatePenaltyEmployeeSelect();
                        }
                    }, (error) => {
                        console.error("Error getting real-time updates:", error);
                        // System continues to work with localStorage if Firebase fails
                    });
            }

            // Add Firebase real-time listener for penalty updates
            function initializePenaltyListener() {
                db.collection('penalties')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot((snapshot) => {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === 'added' || change.type === 'modified') {
                                updatePenaltyUI(change.doc.data());
                            }
                            if (change.type === 'removed') {
                                removePenaltyFromUI(change.doc.id);
                            }
                        });
                    }, (error) => {
                        console.error("Error getting penalty updates:", error);
                    });
            }

            // Helper function to update penalty UI
            function updatePenaltyUI(penalty) {
                const existingRow = document.querySelector(`[data-penalty-id="${penalty.id}"]`);
                if (existingRow) {
                    existingRow.innerHTML = createPenaltyRowContent(penalty);
                } else {
                    const newRow = document.createElement('tr');
                    newRow.dataset.penaltyId = penalty.id;
                    newRow.innerHTML = createPenaltyRowContent(penalty);
                    penaltyList.appendChild(newRow);
                }
            }

            // Helper function to create penalty row content
            function createPenaltyRowContent(penalty) {
                return `
                    <td>${penalty.employeeName}</td>
                    <td>${formatDateSimple(penalty.meetingDate)}</td>
                    <td>${calculateDeadline(penalty.meetingDate)}</td>
                    <td>${penalty.reason}</td>
                    <td>${penalty.status || 'Pending'}</td>
                    <td>
                        ${penalty.status !== 'Completed' ? 
                            `<button class="complete-penalty-btn" data-penalty-id="${penalty.id}">Complete</button>` : 
                            ''}
                    </td>
                `;
            }

            // Helper function to remove penalty from UI
            function removePenaltyFromUI(penaltyId) {
                const row = document.querySelector(`[data-penalty-id="${penaltyId}"]`);
                if (row) {
                    row.remove();
                }
            }

            // Function to handle penalty form submission with Firebase
            async function handlePenaltySubmission(event) {
                event.preventDefault();
                
                try {
                    const formData = new FormData(event.target);
                    const penaltyData = {
                        employeeName: formData.get('employee'),
                        meetingDate: formData.get('meeting-date'),
                        reason: formData.get('reason'),
                        status: 'Pending',
                        createdAt: new Date().toISOString(),
                        lastUpdated: new Date().toISOString()
                    };

                    // Add to Firebase
                    try {
                        const docRef = await db.collection('penalties').add(penaltyData);
                        penaltyData.id = docRef.id;
                        
                        // Log penalty creation
                        await db.collection('penaltyLogs').add({
                            action: 'created',
                            penaltyId: docRef.id,
                            timestamp: new Date().toISOString(),
                            createdBy: getCurrentUser() // Your function to get current user
                        });
                    } catch (error) {
                        console.error('Error adding penalty to Firebase:', error);
                        // Continue with local storage if Firebase fails
                    }

                    // Update UI
                    updatePenaltyUI(penaltyData);
                    
                    // Clear form
                    event.target.reset();

                } catch (error) {
                    console.error('Error submitting penalty:', error);
                    alert('Error submitting penalty. Please try again.');
                }
            }

            // Initialize listeners when the page loads
            document.addEventListener('DOMContentLoaded', function() {
                updatePenaltyEmployeeSelect();
                initializePenaltyEmployeeListener();
                initializePenaltyListener();
                
                // Add form submission listener
                if (penaltyForm) {
                    penaltyForm.addEventListener('submit', handlePenaltySubmission);
                }
            });

            // Add event listener for penalty form submission with Firebase integration
            penaltyForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                
                try {
                    const employeeName = penaltyEmployeeSelect.value;
                    const date = document.getElementById('penalty-date').value;
                    const reason = document.getElementById('penalty-reason').value;
                    const lateMinutes = document.getElementById('penalty-minutes').value;
                    const amount = document.getElementById('penalty-amount').value;
                    const deadline = calculateDeadline(date);

                    if (!employeeName || !date || !reason || !lateMinutes || !amount) {
                        alert('Please fill in all fields');
                        return;
                    }

                    // Create new penalty object
                    const newPenalty = {
                        employeeName,
                        date: formatDateSimple(date),
                        reason,
                        lateMinutes,
                        amount,
                        deadline,
                        createdAt: new Date().toISOString(),
                        status: 'Pending',
                        id: Date.now().toString() // Unique identifier
                    };

                    // Save to both Firebase and localStorage
                    try {
                        // Add to Firebase
                        await db.collection('penalties').doc(newPenalty.id).set(newPenalty);
                        
                        // Log the penalty creation
                        await db.collection('penaltyLogs').add({
                            penaltyId: newPenalty.id,
                            action: 'created',
                            timestamp: new Date().toISOString(),
                            createdBy: getCurrentUser(), // Your function to get current user
                            penaltyDetails: newPenalty
                        });
                    } catch (firebaseError) {
                        console.error('Error saving to Firebase:', firebaseError);
                    }

                    // Save to localStorage as backup
                    const savedPenalties = localStorage.getItem('penaltyData');
                    const penalties = savedPenalties ? JSON.parse(savedPenalties) : [];
                    penalties.push(newPenalty);
                    localStorage.setItem('penaltyData', JSON.stringify(penalties));

                    // Add new row to penalty table
                    const newRow = document.createElement('tr');
                    newRow.dataset.penaltyId = newPenalty.id;
                    newRow.innerHTML = `
                        <td>${employeeName}</td>
                        <td>${formatDateSimple(date)}</td>
                        <td>${reason}</td>
                        <td>${lateMinutes}</td>
                        <td>${amount}</td>
                        <td>${deadline}</td>
                        <td>${newPenalty.status}</td>
                    `;
                    penaltyList.appendChild(newRow);

                    // Clear form
                    penaltyForm.reset();

                } catch (error) {
                    console.error('Error submitting penalty:', error);
                    alert('Error submitting penalty. Please try again.');
                }
            });

            // Updated loadPenalties function with Firebase integration
            async function loadPenalties() {
                try {
                    // Try to get penalties from Firebase first
                    let penalties = [];
                    try {
                        const snapshot = await db.collection('penalties')
                            .orderBy('createdAt', 'desc')
                            .get();
                        
                        penalties = snapshot.docs.map(doc => doc.data());
                        
                        // Update localStorage with Firebase data
                        localStorage.setItem('penaltyData', JSON.stringify(penalties));
                    } catch (firebaseError) {
                        console.error('Error loading from Firebase:', firebaseError);
                        // Fallback to localStorage if Firebase fails
                        const savedPenalties = localStorage.getItem('penaltyData');
                        if (savedPenalties) {
                            penalties = JSON.parse(savedPenalties);
                        }
                    }

                    refreshPenaltyTable(penalties);

                } catch (error) {
                    console.error('Error loading penalties:', error);
                }
            }

            // Function to refresh the penalty table
            function refreshPenaltyTable(penalties) {
                if (!penaltyList) return;
                
                penaltyList.innerHTML = ''; // Clear existing rows
                
                penalties.forEach(penalty => {
                    const row = document.createElement('tr');
                    row.dataset.penaltyId = penalty.id;
                    row.innerHTML = `
                        <td>${penalty.employeeName}</td>
                        <td>${penalty.date}</td>
                        <td>${penalty.reason}</td>
                        <td>${penalty.lateMinutes}</td>
                        <td>${penalty.amount}</td>
                        <td>${penalty.deadline}</td>
                        <td>${penalty.status || 'Pending'}</td>
                    `;
                    penaltyList.appendChild(row);
                });
            }

            // Add Firebase real-time listener for penalty updates
            function initializePenaltyListener() {
                db.collection('penalties')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot((snapshot) => {
                        const penalties = [];
                        snapshot.forEach((doc) => {
                            penalties.push(doc.data());
                        });
                        
                        // Update localStorage
                        localStorage.setItem('penaltyData', JSON.stringify(penalties));
                        
                        // Refresh the table
                        refreshPenaltyTable(penalties);
                    }, (error) => {
                        console.error("Error getting real-time updates:", error);
                        // System continues to work with localStorage if Firebase fails
                    });
            }

            // Function to update a penalty's status
            async function updatePenaltyStatus(penaltyId, newStatus) {
                try {
                    await db.collection('penalties').doc(penaltyId).update({
                        status: newStatus,
                        updatedAt: new Date().toISOString()
                    });

                    // Log the status update
                    await db.collection('penaltyLogs').add({
                        penaltyId: penaltyId,
                        action: 'status_updated',
                        newStatus: newStatus,
                        timestamp: new Date().toISOString(),
                        updatedBy: getCurrentUser()
                    });
                } catch (error) {
                    console.error('Error updating penalty status:', error);
                    // Update localStorage as fallback
                    const savedPenalties = JSON.parse(localStorage.getItem('penaltyData'));
                    const updatedPenalties = savedPenalties.map(p => {
                        if (p.id === penaltyId) {
                            return { ...p, status: newStatus };
                        }
                        return p;
                    });
                    localStorage.setItem('penaltyData', JSON.stringify(updatedPenalties));
                }
            }

            // Initialize listeners when the page loads
            document.addEventListener('DOMContentLoaded', function() {
                loadPenalties();
                initializePenaltyListener();
            });

            // Update the penalty form submission with Firebase integration
            penaltyForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                
                try {
                    const employeeName = penaltyEmployeeSelect.value;
                    const date = document.getElementById('penalty-date').value;
                    const reason = document.getElementById('penalty-reason').value;
                    const lateMinutes = parseInt(document.getElementById('penalty-minutes').value);

                    if (!employeeName || !date || !reason || !lateMinutes) {
                        alert('Please fill in all fields');
                        return;
                    }

                    // Get employee data from Firebase, fallback to localStorage
                    let employeeData;
                    try {
                        const doc = await db.collection('systemData').doc('employeeData').get();
                        employeeData = doc.exists ? JSON.parse(doc.data().value) : JSON.parse(localStorage.getItem('employeeData'));
                    } catch (error) {
                        console.error('Error fetching from Firebase:', error);
                        employeeData = JSON.parse(localStorage.getItem('employeeData'));
                    }

                    const employee = employeeData.find(emp => emp.name === employeeName);
                    const employeeRole = employee ? employee.role : '';

                    // Calculate base amount based on minutes (logic remains unchanged)
                    let amount;
                    if (reason === 'Meeting') {
                        if (lateMinutes >= 480) { // No show
                            amount = 200;
                        } else if (lateMinutes <= 5) {
                            amount = 20;
                        } else if (5 < lateMinutes && lateMinutes <= 10) {
                            amount = 40;
                        } else if (10 < lateMinutes && lateMinutes <= 15) {
                            amount = 60;
                        } else {
                            amount = 100;
                        }

                        // Apply role multiplier
                        switch (employeeRole) {
                            case 'AUM/UM':
                                amount *= 1.5;
                                break;
                            case 'SUM':
                                amount *= 2;
                                break;
                            case 'BM':
                                amount *= 3;
                                break;
                            case 'DM':
                                amount *= 4;
                                break;
                            case 'DD':
                                amount *= 6;
                                break;
                            default:
                                // No multiplier for other roles
                                break;
                        }
                    
                    } else if (reason === '衣著') {
                        amount = 250; // Fixed amount for dress code violation
                    }

                    // Round amount to nearest integer
                    amount = Math.round(amount);

                    const deadline = calculateDeadline(date);

                    // Create new penalty object with additional Firebase-specific fields
                    const newPenalty = {
                        id: Date.now().toString(), // Unique identifier
                        employeeName,
                        date: formatDateSimple(date),
                        reason,
                        lateMinutes,
                        amount,
                        deadline,
                        status: 'Pending',
                        createdAt: new Date().toISOString(),
                        employeeRole, // Store role for reference
                        calculationDetails: {
                            baseAmount: amount / (employeeRole ? getRoleMultiplier(employeeRole) : 1),
                            roleMultiplier: getRoleMultiplier(employeeRole),
                            finalAmount: amount
                        }
                    };

                    // Save to Firebase
                    try {
                        await db.collection('penalties').doc(newPenalty.id).set(newPenalty);
                        
                        // Log the penalty creation with calculation details
                        await db.collection('penaltyLogs').add({
                            penaltyId: newPenalty.id,
                            action: 'created',
                            timestamp: new Date().toISOString(),
                            createdBy: getCurrentUser(),
                            calculationDetails: newPenalty.calculationDetails,
                            penaltyData: newPenalty
                        });
                    } catch (firebaseError) {
                        console.error('Error saving to Firebase:', firebaseError);
                    }

                    // Save to localStorage as backup
                    const savedPenalties = localStorage.getItem('penaltyData');
                    const penalties = savedPenalties ? JSON.parse(savedPenalties) : [];
                    penalties.push(newPenalty);
                    localStorage.setItem('penaltyData', JSON.stringify(penalties));

                    // Refresh the penalty table
                    refreshPenaltyTable(penalties);

                    // Clear form
                    penaltyForm.reset();

                } catch (error) {
                    console.error('Error processing penalty submission:', error);
                    alert('Error creating penalty. Please try again.');
                }
            });

            // Helper function to get role multiplier
            function getRoleMultiplier(role) {
                const multipliers = {
                    'AUM/UM': 1.5,
                    'SUM': 2,
                    'BM': 3,
                    'DM': 4,
                    'DD': 6,
                    'Agent': 1
                };
                return multipliers[role] || 1;
            }

            // Function to refresh penalty table with real-time data
            function refreshPenaltyTable(penalties) {
                const penaltyList = document.getElementById('penalty-list');
                if (!penaltyList) return;

                penaltyList.innerHTML = '';
                penalties.forEach(penalty => {
                    const row = document.createElement('tr');
                    row.dataset.penaltyId = penalty.id;
                    row.innerHTML = `
                        <td>${penalty.employeeName}</td>
                        <td>${penalty.date}</td>
                        <td>${penalty.reason}</td>
                        <td>${penalty.lateMinutes}</td>
                        <td>${penalty.amount}</td>
                        <td>${penalty.deadline}</td>
                        <td>${penalty.status || 'Pending'}</td>
                    `;
                    penaltyList.appendChild(row);
                });
            }

            // Add Firebase real-time listener for penalty updates
            function initializePenaltyListener() {
                db.collection('penalties')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot((snapshot) => {
                        const penalties = [];
                        snapshot.forEach((doc) => {
                            penalties.push(doc.data());
                        });
                        
                        // Update localStorage
                        localStorage.setItem('penaltyData', JSON.stringify(penalties));
                        
                        // Refresh the table
                        refreshPenaltyTable(penalties);
                    }, (error) => {
                        console.error("Error getting real-time updates:", error);
                        // System continues to work with localStorage if Firebase fails
                    });
            }

            // Initialize Firebase listeners when page loads
            document.addEventListener('DOMContentLoaded', function() {
                initializePenaltyListener();
            });

            // Update the initializePenaltySection function with Firebase integration
            async function initializePenaltySection() {
                await updatePenaltyEmployeeSelect();
                await loadPenalties();
                initializeFirebaseListeners();
            }

            // Initialize Firebase listeners
            function initializeFirebaseListeners() {
                // Listen for employee data changes
                db.collection('systemData').doc('employeeData')
                    .onSnapshot((doc) => {
                        if (doc.exists && doc.data()) {
                            const employeeData = JSON.parse(doc.data().value);
                            localStorage.setItem('employeeData', JSON.stringify(employeeData));
                            updatePenaltyEmployeeSelect();
                        }
                    }, (error) => {
                        console.error("Error getting employee updates:", error);
                    });

                // Listen for penalty data changes
                db.collection('penalties')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot((snapshot) => {
                        const penalties = snapshot.docs.map(doc => doc.data());
                        localStorage.setItem('penaltyData', JSON.stringify(penalties));
                        refreshPenaltyTable(penalties);
                    }, (error) => {
                        console.error("Error getting penalty updates:", error);
                    });
            }

            // Keep the existing window.load event listener
            window.addEventListener('load', initializePenaltySection);

            // Export functions with Firebase integration
            function exportToExcel(data, filename) {
                // Convert data to worksheet
                const ws = XLSX.utils.json_to_sheet(data);
                
                // Create workbook and add worksheet
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                
                // Save file
                XLSX.writeFile(wb, filename);

                // Log export activity to Firebase
                logExportActivity(filename, data.length);
            }

            // Function to log export activity
            async function logExportActivity(filename, recordCount) {
                try {
                    await db.collection('exportLogs').add({
                        filename: filename,
                        recordCount: recordCount,
                        exportedBy: getCurrentUser(),
                        timestamp: new Date().toISOString(),
                        type: filename.includes('leave') ? 'leave_applications' : 'other'
                    });
                } catch (error) {
                    console.error('Error logging export activity:', error);
                }
            }

            // Function to export applications with Firebase integration
            async function exportApplications() {
                try {
                    // Try to get data from Firebase first
                    let employeeData;
                    try {
                        const doc = await db.collection('systemData').doc('employeeData').get();
                        employeeData = doc.exists ? JSON.parse(doc.data().value) : JSON.parse(localStorage.getItem('employeeData'));
                    } catch (error) {
                        console.error('Error fetching from Firebase:', error);
                        employeeData = JSON.parse(localStorage.getItem('employeeData'));
                    }

                    if (employeeData) {
                        // Prepare data for export
                        const exportData = [];
                        
                        employeeData.forEach(employee => {
                            if (employee.applications) {
                                employee.applications.forEach(application => {
                                    exportData.push({
                                        'Agent Name': employee.name,
                                        'Apply Date': application.applyDate,
                                        'Leave Start Date': application.leaveStartDate,
                                        'Leave End Date': application.leaveEndDate,
                                        'Leave Type': application.leaveType,
                                        'Status': application.status,
                                        'Role': employee.role || 'N/A',
                                        'MDRT Status': employee.empMDRT || 'N/A'
                                    });
                                });
                            }
                        });
                        
                        // Sort by date (newest first)
                        exportData.sort((a, b) => {
                            return new Date(b['Apply Date']) - new Date(a['Apply Date']);
                        });
                        
                        // Export to Excel
                        const filename = `leave_applications_${formatDateSimple(new Date())}.xlsx`;
                        exportToExcel(exportData, filename);

                        // Log successful export
                        try {
                            await db.collection('exportLogs').add({
                                type: 'leave_applications',
                                recordCount: exportData.length,
                                exportedBy: getCurrentUser(),
                                timestamp: new Date().toISOString(),
                                filename: filename,
                                filters: {
                                    dateRange: `All dates up to ${formatDateSimple(new Date())}`,
                                    includedFields: Object.keys(exportData[0] || {})
                                }
                            });
                        } catch (error) {
                            console.error('Error logging export:', error);
                        }
                    }
                } catch (error) {
                    console.error('Error exporting applications:', error);
                    alert('Error exporting applications. Please try again.');
                }
            }

            // Helper function to get current timestamp in local timezone
            function getLocalTimestamp() {
                const now = new Date();
                return now.toLocaleString();
            }

            // Helper function to format date for filename
            function formatDateForFilename(date) {
                return formatDateSimple(date).replace(/\//g, '-');
            }

            // Initialize export functionality when page loads
            document.addEventListener('DOMContentLoaded', function() {
                const exportButton = document.getElementById('export-button');
                if (exportButton) {
                    exportButton.addEventListener('click', exportApplications);
                }
            });

            // Function to export penalties with Firebase integration
            async function exportPenalties() {
                try {
                    // Try to get data from Firebase first, fallback to localStorage
                    let penalties;
                    try {
                        const snapshot = await db.collection('penalties')
                            .orderBy('createdAt', 'desc')
                            .get();
                        penalties = snapshot.docs.map(doc => doc.data());
                        
                        // Update localStorage with latest data
                        localStorage.setItem('penaltyData', JSON.stringify(penalties));
                    } catch (firebaseError) {
                        console.error('Error fetching from Firebase:', firebaseError);
                        const savedPenalties = localStorage.getItem('penaltyData');
                        penalties = savedPenalties ? JSON.parse(savedPenalties) : [];
                    }

                    if (penalties.length > 0) {
                        // Prepare data for export
                        const exportData = penalties.map(penalty => {
                            const isPast = isPastDeadline(penalty.deadline);
                            const finalAmount = (isPast && !penalty.cancelDouble) ? penalty.amount * 2 : penalty.amount;
                            
                            return {
                                'Agent Name': penalty.employeeName,
                                'Date': penalty.date,
                                'Reason': penalty.reason,
                                'Late Minutes': penalty.lateMinutes === 500 ? 'No Show' : penalty.lateMinutes,
                                'Amount': `$${penalty.amount}`,
                                'Final Amount': `$${finalAmount}`,
                                'Deadline': penalty.deadline,
                                'Status': penalty.submitted ? 'Submitted' : 'Not Submitted',
                                'Double Cancelled': penalty.cancelDouble ? 'Yes' : 'No',
                                'Role': penalty.employeeRole || 'N/A',
                                'Last Updated': penalty.lastUpdated || penalty.createdAt || 'N/A'
                            };
                        });
                        
                        // Sort by date (newest first)
                        exportData.sort((a, b) => {
                            return new Date(b.Date) - new Date(a.Date);
                        });
                        
                        // Generate filename with timestamp
                        const filename = `penalties_${formatDateForFilename(new Date())}.xlsx`;
                        
                        // Create and customize worksheet
                        const ws = XLSX.utils.json_to_sheet(exportData);
                        setExcelColumnWidths(ws);
                        
                        // Create workbook and add worksheet
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "Penalties");
                        
                        // Save file
                        XLSX.writeFile(wb, filename);

                        // Log export to Firebase
                        try {
                            await db.collection('exportLogs').add({
                                type: 'penalties',
                                filename: filename,
                                recordCount: exportData.length,
                                exportedBy: getCurrentUser(),
                                timestamp: new Date().toISOString(),
                                summary: {
                                    totalPenalties: exportData.length,
                                    totalAmount: exportData.reduce((sum, record) => sum + parseFloat(record['Final Amount'].replace('$', '')), 0),
                                    dateRange: `${exportData[exportData.length - 1].Date} to ${exportData[0].Date}`
                                }
                            });
                        } catch (logError) {
                            console.error('Error logging export:', logError);
                        }
                    }
                } catch (error) {
                    console.error('Error exporting penalties:', error);
                    alert('Error exporting penalties. Please try again.');
                }
            }

            // Add event listeners for the export buttons
            document.addEventListener('DOMContentLoaded', function() {
                const exportApplicationsBtn = document.getElementById('export-applications-btn');
                const exportPenaltiesBtn = document.getElementById('export-penalties-btn');
                
                if (exportApplicationsBtn) {
                    exportApplicationsBtn.addEventListener('click', exportApplications);
                }
                
                if (exportPenaltiesBtn) {
                    exportPenaltiesBtn.addEventListener('click', exportPenalties);
                }
            });

            // Format date consistently
            function formatExportDate(dateString) {
                const date = new Date(dateString);
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            }

            // Format date for filename
            function formatDateForFilename(date) {
                return formatExportDate(date).replace(/-/g, '');
            }

            // Custom column width settings for better Excel display
            function setExcelColumnWidths(ws) {
                const columnWidths = [
                    { wch: 15 },  // Agent Name
                    { wch: 20 },  // Date/Apply Date
                    { wch: 15 },  // Reason/Leave Type
                    { wch: 12 },  // Late Minutes/Status
                    { wch: 10 },  // Amount
                    { wch: 12 },  // Final Amount
                    { wch: 12 },  // Deadline/Status
                    { wch: 10 },  // Role
                    { wch: 20 }   // Last Updated
                ];
                
                ws['!cols'] = columnWidths;
            }

            // Helper function to check if deadline is past
            function isPastDeadline(deadline) {
                const today = new Date();
                const deadlineDate = new Date(deadline);
                return today > deadlineDate;
            }

            // Initialize Firebase real-time listener for penalties
            function initializePenaltyListener() {
                db.collection('penalties')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot((snapshot) => {
                        const penalties = snapshot.docs.map(doc => doc.data());
                        localStorage.setItem('penaltyData', JSON.stringify(penalties));
                    }, (error) => {
                        console.error("Error getting real-time updates:", error);
                    });
            }

            // Initialize when page loads
            document.addEventListener('DOMContentLoaded', function() {
                initializePenaltyListener();
            });

        </script>

        <script>
            // Initialize Firebase Realtime Listeners
            document.addEventListener('DOMContentLoaded', () => {
                const db = firebase.firestore();
                let unsubscribeEmployeeData;
                let unsubscribeApplications;
                let unsubscribePenalties;
                
                // Initialize real-time listeners with error handling and reconnection logic
                function initializeFirebaseListeners() {
                    // Listen for employee data changes
                    unsubscribeEmployeeData = db.collection('systemData').doc('employeeData')
                        .onSnapshot((doc) => {
                            try {
                                if (doc.exists && doc.data()) {
                                    const newData = doc.data().value;
                                    localStorage.setItem('employeeData', newData);
                                    
                                    // Update UI based on current page
                                    const employeeData = JSON.parse(newData);
                                    updateUIBasedOnPage(employeeData);
                                    
                                    // Log successful sync
                                    logSync('employeeData', true);
                                }
                            } catch (error) {
                                console.error('Error processing employee data:', error);
                                handleSyncError('employeeData', error);
                            }
                        }, handleFirebaseError);

                    // Listen for leave applications
                    unsubscribeApplications = db.collection('systemData').doc('applications')
                        .onSnapshot((doc) => {
                            try {
                                if (doc.exists && doc.data()) {
                                    const newData = doc.data().value;
                                    localStorage.setItem('applications', newData);
                                    
                                    // Update UI based on current page
                                    updateApplicationsUI(JSON.parse(newData));
                                    
                                    // Log successful sync
                                    logSync('applications', true);
                                }
                            } catch (error) {
                                console.error('Error processing applications:', error);
                                handleSyncError('applications', error);
                            }
                        }, handleFirebaseError);

                    // Listen for penalties
                    unsubscribePenalties = db.collection('systemData').doc('penaltyData')
                        .onSnapshot((doc) => {
                            try {
                                if (doc.exists && doc.data()) {
                                    const newData = doc.data().value;
                                    localStorage.setItem('penaltyData', newData);
                                    
                                    // Update UI based on current page
                                    updatePenaltiesUI(JSON.parse(newData));
                                    
                                    // Log successful sync
                                    logSync('penaltyData', true);
                                }
                            } catch (error) {
                                console.error('Error processing penalties:', error);
                                handleSyncError('penaltyData', error);
                            }
                        }, handleFirebaseError);
                }

                // Helper function to update UI based on current page
                function updateUIBasedOnPage(employeeData) {
                    const adminPage = document.getElementById('admin-page');
                    const employeePage = document.getElementById('employee-page');

                    if (adminPage && adminPage.style.display === 'block') {
                        // Update admin page UI
                        const employeeList = document.getElementById('employee-list');
                        if (employeeList) refreshEmployeeList(employeeData);

                        const penaltySelect = document.getElementById('penalty-employee');
                        if (penaltySelect) updatePenaltyEmployeeList(employeeData);
                    }

                    if (employeePage && employeePage.style.display === 'block') {
                        const currentEmployee = document.getElementById('employee-name')?.textContent;
                        if (currentEmployee) {
                            const employee = employeeData.find(emp => emp.name === currentEmployee);
                            if (employee) updateEmployeeInfo(employee);
                        }
                    }
                }

                // Helper function to update applications UI
                function updateApplicationsUI(applications) {
                    const adminPage = document.getElementById('admin-page');
                    const employeePage = document.getElementById('employee-page');

                    if (adminPage?.style.display === 'block') {
                        const applicationList = document.getElementById('application-list-body');
                        if (applicationList) refreshApplicationList(applications);
                    }

                    if (employeePage?.style.display === 'block') {
                        const currentEmployee = document.getElementById('employee-name')?.textContent;
                        if (currentEmployee) updateEmployeeApplicationStatus(currentEmployee);
                    }
                }

                // Helper function to update penalties UI
                function updatePenaltiesUI(penalties) {
                    const adminPage = document.getElementById('admin-page');
                    const employeePage = document.getElementById('employee-page');

                    if (adminPage?.style.display === 'block') {
                        const penaltyList = document.getElementById('penalty-list');
                        if (penaltyList) refreshPenaltyList(penalties);
                    }

                    if (employeePage?.style.display === 'block') {
                        const currentEmployee = document.getElementById('employee-name')?.textContent;
                        if (currentEmployee) updateEmployeePenalties(currentEmployee);
                    }
                }

                // Helper function to show sync status with enhanced feedback
                function showSyncStatus(success = true) {
                    const syncStatus = document.getElementById('sync-status');
                    if (syncStatus) {
                        syncStatus.className = `sync-status ${success ? 'success' : 'error'}`;
                        syncStatus.textContent = success ? 'Changes saved' : 'Sync error';
                        syncStatus.style.display = 'block';
                        setTimeout(() => {
                            syncStatus.style.display = 'none';
                        }, 2000);
                    }
                }

                // Error handling for Firebase operations
                function handleFirebaseError(error) {
                    console.error('Firebase error:', error);
                    showSyncStatus(false);
                    
                    // Attempt to reconnect after delay
                    setTimeout(initializeFirebaseListeners, 5000);
                }

                // Handle sync errors
                function handleSyncError(dataType, error) {
                    console.error(`Sync error for ${dataType}:`, error);
                    showSyncStatus(false);
                    
                    // Log sync error
                    logSync(dataType, false, error.message);
                }

                // Log sync operations
                async function logSync(dataType, success, errorMessage = null) {
                    try {
                        await db.collection('syncLogs').add({
                            dataType,
                            success,
                            errorMessage,
                            timestamp: new Date().toISOString(),
                            user: getCurrentUser()
                        });
                    } catch (error) {
                        console.error('Error logging sync:', error);
                    }
                }

                // Override localStorage with Firebase sync
                const originalSetItem = localStorage.setItem;
                localStorage.setItem = async function(key, value) {
                    // Call original localStorage
                    originalSetItem.apply(this, arguments);
                    
                    // Sync to Firebase for specific keys
                    if (['employeeData', 'applications', 'penaltyData'].includes(key)) {
                        try {
                            await db.collection('systemData').doc(key).set({
                                value: value,
                                timestamp: new Date().toISOString(),
                                lastModifiedBy: getCurrentUser()
                            });
                            showSyncStatus(true);
                        } catch (error) {
                            console.error('Firebase sync error:', error);
                            showSyncStatus(false);
                            handleSyncError(key, error);
                        }
                    }
                };

                // Initialize listeners
                initializeFirebaseListeners();

                // Cleanup on page unload
                window.addEventListener('unload', () => {
                    if (unsubscribeEmployeeData) unsubscribeEmployeeData();
                    if (unsubscribeApplications) unsubscribeApplications();
                    if (unsubscribePenalties) unsubscribePenalties();
                });
            });
            </script>

    </body>

    </html>


